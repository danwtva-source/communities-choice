<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Communities' Choice PB Initiative - Torfaen</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- SwiperJS for Carousel -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css"/>
  <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DynaPuff:wght@400;700&display=swap" rel="stylesheet">

  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <style>
    /* ------------------- */
    /* Global & Font Setup */
    /* ------------------- */
    :root {
      --timeline-scale: 1.0;
    }
    html.timeline-fullscreen {
      overflow: hidden; /* Prevent scrolling of the body in fullscreen */
    }
    h1, h2, h3, .dynapuff {
      font-family: 'DynaPuff', cursive !important;
    }
    body, p, li, span, a, div, button, ul, table, input, select, textarea, .arial-nova {
      font-family: 'Arial Nova', Arial, Helvetica, sans-serif !important;
    }
    /* Hide pages by default */
    .page, .portal-page {
      display: none;
    }

    /* ---------------- */
    /* Carousel Styles  */
    /* ---------------- */
    .swiper {
      width: 100%;
      height: 500px;
    }
    .swiper-slide {
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      background: #fafafa;
      border-radius: 1rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      padding: 2rem;
      height: 460px; /* Adjusted height */
      text-align: center;
    }
    .area-img {
      width: 100%;
      max-width: 420px;
      height: auto;
      border-radius: 0.75rem;
      box-shadow: 0 2px 10px rgba(80,0,100,0.08);
      margin-bottom: 1.5rem;
      background: #fff;
    }
    /* Custom Swiper navigation colors */
    .swiper-button-next, .swiper-button-prev {
        color: #9333ea !important;
    }
    .swiper-pagination-bullet-active {
        background: #9333ea !important;
    }
    
    /* ---------------- */
    /* Timeline Styles  */
    /* ---------------- */
     #timeline-fullscreen-container {
      transition: all 0.3s ease-in-out;
    }
    #timeline-fullscreen-container.fullscreen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #f3e8ff; /* A light purple background for fullscreen mode */
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1rem;
    }
    .timeline-bar {
      position: relative;
      height: calc(360px * var(--timeline-scale));
      min-width: calc(1200px * var(--timeline-scale));
      padding-bottom: calc(10px * var(--timeline-scale));
      transform-origin: top left;
      transition: all 0.3s ease;
    }
    .timeline-line {
      position: absolute;
      top: calc(160px * var(--timeline-scale));
      left: 5%;
      width: 90%;
      height: calc(6px * var(--timeline-scale));
      background: linear-gradient(90deg, #9333ea 60%, #14b8a6 100%);
      border-radius: calc(4px * var(--timeline-scale));
      z-index: 0;
    }
    .milestone {
      position: absolute;
      width: calc(36px * var(--timeline-scale));
      height: calc(36px * var(--timeline-scale));
      border-radius: 50%;
      border: calc(3px * var(--timeline-scale)) solid #a78bfa;
      background: #fff;
      color: #9333ea;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2;
      transition: transform 0.2s, box-shadow 0.2s, border-color 0.2s;
    }
    .milestone.active {
      border-color: #9333ea;
      box-shadow: 0 0 0 calc(6px * var(--timeline-scale)) #e9d5ff;
      transform: scale(1.12);
    }
    .milestone.completed {
      background: #9333ea;
      color: #fff;
      border-color: #9333ea;
    }
    .milestone.upcoming {
      background: #e9d5ff;
      color: #9333ea;
      border-color: #a78bfa;
    }
    .milestone:hover {
      cursor: pointer;
      box-shadow: 0 0 0 calc(8px * var(--timeline-scale)) #d1fae5;
      border-color: #14b8a6;
    }
    .connector {
      position: absolute;
      width: 0;
      border-left: calc(3px * var(--timeline-scale)) solid #a78bfa;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1;
    }
    .milestone-label, .milestone-date {
      position: absolute;
      width: calc(180px * var(--timeline-scale));
      max-width: calc(180px * var(--timeline-scale));
      text-align: center;
      left: 50%;
      transform: translateX(-50%);
      z-index: 3;
      pointer-events: none;
      word-break: break-word;
      white-space: normal;
    }
    .milestone-label {
      font-size: calc(1.05rem * var(--timeline-scale));
      font-weight: 500;
      color: #374151;
      font-family: 'DynaPuff', cursive !important;
      line-height: 1.2;
    }
    .milestone-date {
      font-size: calc(0.95rem * var(--timeline-scale));
      color: #6b7280;
      font-family: 'Arial Nova', Arial, Helvetica, sans-serif !important;
      line-height: 1.2;
    }
    .milestone.above { top: calc(54px * var(--timeline-scale)); }
    .milestone.below { top: calc(210px * var(--timeline-scale)); }
    .connector.above { top: calc(90px * var(--timeline-scale)); height: calc(70px * var(--timeline-scale)); }
    .connector.below { top: calc(196px * var(--timeline-scale)); height: calc(70px * var(--timeline-scale)); }
    .milestone-label.above { top: calc(-18px * var(--timeline-scale)); }
    .milestone-label.below { top: calc(265px * var(--timeline-scale)); margin-bottom: calc(14px * var(--timeline-scale)); }
    .milestone-date.above { top: calc(25px * var(--timeline-scale)); }
    .milestone-date.below { top: calc(310px * var(--timeline-scale)); }
    
    .timeline-scroll::-webkit-scrollbar { display: none; }
    .timeline-scroll {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }

    /* Timeline Callout Styles */
    .timeline-callout {
        position: absolute;
        width: calc(380px * var(--timeline-scale));
        background: #ffffff; /* Opaque background */
        border: 1px solid #e9d5ff;
        border-radius: calc(0.75rem * var(--timeline-scale));
        box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        z-index: 20;
        transition: opacity 0.3s ease, transform 0.3s ease;
        opacity: 0;
        pointer-events: none;
        transform: translateY(calc(10px * var(--timeline-scale)));
    }
    .timeline-callout.show {
        opacity: 1;
        pointer-events: auto;
        transform: translateY(0);
    }
    .timeline-callout::before {
        content: '';
        position: absolute;
        width: 0;
        height: 0;
        border-style: solid;
        left: 50%;
        transform: translateX(-50%);
        border-color: transparent;
    }
    .timeline-callout.from-above::before {
        top: calc(-10px * var(--timeline-scale));
        border-width: 0 calc(10px * var(--timeline-scale)) calc(10px * var(--timeline-scale)) calc(10px * var(--timeline-scale));
        border-bottom-color: #e9d5ff;
    }
     .timeline-callout.from-below::before {
        bottom: calc(-10px * var(--timeline-scale));
        border-width: calc(10px * var(--timeline-scale)) calc(10px * var(--timeline-scale)) 0 calc(10px * var(--timeline-scale));
        border-top-color: #e9d5ff;
    }
    /* Scale content inside callout */
    .timeline-callout > div {
      font-size: calc(1rem * var(--timeline-scale));
      padding: calc(1rem * var(--timeline-scale));
    }
     .timeline-callout h3 {
      font-size: calc(1.125rem * var(--timeline-scale));
       margin-bottom: calc(0.5rem * var(--timeline-scale));
    }
     .timeline-callout ul {
      margin-left: calc(1.5rem * var(--timeline-scale));
    }

    /* ------------------- */
    /* Priorities Page Styles */
    /* ------------------- */
    .priority-card {
      background: linear-gradient(135deg, #fdfcff 0%, #f7f5ff 100%);
      border: 1px solid #e9d5ff;
      transition: all 0.3s ease;
    }
    .priority-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 20px rgba(147, 51, 234, 0.1);
      border-color: #c084fc;
    }
    .tab-button {
      transition: all 0.3s ease;
      border-bottom: 4px solid transparent;
    }
    .tab-button.active {
      border-color: #9333ea;
      color: #9333ea;
      background-color: #f3e8ff;
    }
    /* ------------------- */
    /* FAQ Page Styles     */
    /* ------------------- */
    .faq-item summary {
      cursor: pointer;
      outline: none;
      transition: background-color 0.2s ease;
    }
    .faq-item summary::-webkit-details-marker {
      display: none;
    }
    .faq-item summary .icon {
      transition: transform 0.3s ease;
    }
    .faq-item[open] summary .icon {
      transform: rotate(45deg);
    }
    .faq-item[open] summary {
      background-color: #f3e8ff;
    }

    /* ------------------- */
    /* Scoring & Portal Styles */
    /* ------------------- */
    .scoring-table th, .scoring-table td {
        padding: 0.75rem;
        vertical-align: middle;
    }
    .tooltip-container {
        position: relative;
        display: inline-block;
    }
    .tooltip-icon {
        cursor: pointer;
        margin-left: 8px;
        color: #a78bfa;
    }
    .tooltip-text {
        visibility: hidden;
        width: 320px;
        background-color: #555;
        color: #fff;
        text-align: left;
        border-radius: 6px;
        padding: 10px;
        position: absolute;
        z-index: 10;
        bottom: 125%;
        left: 50%;
        margin-left: -160px;
        opacity: 0;
        transition: opacity 0.3s;
        font-family: 'Arial Nova', Arial, Helvetica, sans-serif !important;
        font-size: 0.875rem;
    }
    .tooltip-text::after {
        content: "";
        position: absolute;
        top: 100%;
        left: 50%;
        margin-left: -5px;
        border-width: 5px;
        border-style: solid;
        border-color: #555 transparent transparent transparent;
    }
    .tooltip-container:hover .tooltip-text {
        visibility: visible;
        opacity: 1;
    }
    /* Custom range slider style */
    input[type="range"].score-slider {
      -webkit-appearance: none;
      width: 100%;
      height: 8px;
      background: #e9d5ff;
      border-radius: 5px;
      outline: none;
      opacity: 0.9;
      transition: opacity .2s;
    }
    input[type="range"].score-slider:hover {
      opacity: 1;
    }
    input[type="range"].score-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 20px;
      height: 20px;
      background: #9333ea;
      cursor: pointer;
      border-radius: 50%;
      border: 2px solid white;
      box-shadow: 0 0 5px rgba(0,0,0,0.2);
    }
    input[type="range"].score-slider::-moz-range-thumb {
      width: 20px;
      height: 20px;
      background: #9333ea;
      cursor: pointer;
      border-radius: 50%;
      border: 2px solid white;
      box-shadow: 0 0 5px rgba(0,0,0,0.2);
    }
    /* PDF Viewer Draggable Window */
    #pdf-viewer-window {
        z-index: 1001; /* Ensure it's on top */
    }
    #pdf-viewer-header {
        cursor: move;
    }
     .task-list-button {
        cursor: pointer;
        transition: background-color 0.2s;
    }
    .task-list-button:hover {
        background-color: #f3e8ff;
    }
  </style>
</head>
<body class="bg-gradient-to-br from-purple-100 via-purple-200 to-teal-100 min-h-screen">

  <!-- Header & Navigation -->
  <header class="bg-white/80 backdrop-blur-sm shadow-md sticky top-0 z-50">
      <div class="container mx-auto flex justify-between items-center p-4">
          <div class="flex items-center space-x-3">
              <img src="https://d41chssnpqdne.cloudfront.net/user_upload_by_module/chat_bot/files/970258/XU0aJN5kLsT4Hiln.png?Expires=1758359968&Signature=m4JUd4i7qveZkQSjPA3DE3SX7em-IkAR4kLSYZF6Cli6Wmqncgv9re65ERZTY4t00ObtvWHltRUvrO7EWUhwu5ezO0tW7qXQyOhp~7iUaSYKADQOnrJx9kzCYuZNhn289oiztKsQLYlaUDziLIGZEGHWZ3998hKXzR2gVQJMcG1GJpjeUxouVTNSR5Ia1tO~xcVcdIncJU5IM-tC7wt9d-IJUvkmnowjtq6~qszjtVaddTN5Wti-XfEzJtUgfU3lZlj9vd07DqmxwLlna1TM9wajPnbEuyT3i0oHR9OJRbOP09h0W4RYRarVNiJ5YhwVqO~0P2Fj6tpThtXF0o-klQ__&Key-Pair-Id=K3USGZIKWMDCSX" alt="Logo" class="h-12 rounded-lg">
              <h1 class="text-xl font-bold text-purple-700 dynapuff hidden sm:block">Communities' Choice</h1>
          </div>
          <nav id="main-nav" class="flex items-center space-x-1 sm:space-x-2 text-xs sm:text-base flex-wrap justify-end">
              <button onclick="showPage('page-postcode-check')" class="text-purple-700 hover:bg-purple-100 font-semibold py-2 px-3 rounded-lg transition duration-200 dynapuff">Vote</button>
              <button onclick="showPage('page-landing')" class="text-purple-700 hover:bg-purple-100 font-semibold py-2 px-3 rounded-lg transition duration-200 dynapuff">Browse Areas</button>
              <button onclick="showPage('page-priorities')" class="text-purple-700 hover:bg-purple-100 font-semibold py-2 px-3 rounded-lg transition duration-200 dynapuff">Our Priorities</button>
              <button onclick="showPage('page-documents')" class="text-purple-700 hover:bg-purple-100 font-semibold py-2 px-3 rounded-lg transition duration-200 dynapuff">Documents</button>
              <button onclick="showPage('page-timeline')" class="text-purple-700 hover:bg-purple-100 font-semibold py-2 px-3 rounded-lg transition duration-200 dynapuff">Timeline</button>
              <button onclick="showPage('page-faq')" class="text-purple-700 hover:bg-purple-100 font-semibold py-2 px-3 rounded-lg transition duration-200 dynapuff">FAQ</button>
              <button onclick="showPage('page-portal-login')" class="bg-purple-100 text-purple-800 hover:bg-purple-200 font-semibold py-2 px-3 rounded-lg transition duration-200 dynapuff border border-purple-300">Committee Portal</button>
          </nav>
           <nav id="portal-nav" class="hidden items-center space-x-1 sm:space-x-2 text-xs sm:text-base flex-wrap justify-end">
                <div id="user-info" class="text-sm text-purple-800 font-semibold mr-4"></div>
                <button id="nav-portal-home" onclick="showPortalPage('page-portal-dashboard')" class="text-purple-700 hover:bg-purple-100 font-semibold py-2 px-3 rounded-lg transition duration-200 dynapuff">Portal Home</button>
                <button onclick="showPortalPage('page-scoring')" class="text-purple-700 hover:bg-purple-100 font-semibold py-2 px-3 rounded-lg transition duration-200 dynapuff">Scoring Matrix</button>
                <button onclick="showPortalPage('page-portal-apps')" class="text-purple-700 hover:bg-purple-100 font-semibold py-2 px-3 rounded-lg transition duration-200 dynapuff">Applications</button>
                <button onclick="showPortalPage('page-portal-docs')" class="text-purple-700 hover:bg-purple-100 font-semibold py-2 px-3 rounded-lg transition duration-200 dynapuff">Documents</button>
                <button id="nav-master-tracker" onclick="showPortalPage('page-portal-tracker')" class="text-purple-700 hover:bg-purple-100 font-semibold py-2 px-3 rounded-lg transition duration-200 dynapuff admin-only" style="display: none;">Master Tracker</button>
                <button onclick="logout()" class="bg-red-100 text-red-700 hover:bg-red-200 font-semibold py-2 px-3 rounded-lg transition duration-200 dynapuff">Logout</button>
            </nav>
      </div>
  </header>

  <main>
    <!-- ======================= -->
    <!-- PUBLIC PAGES            -->
    <!-- ======================= -->
    
    <!-- POSTCODE CHECKER PAGE   -->
    <div id="page-postcode-check" class="page">
      <!-- Hero Section -->
      <div class="flex flex-col items-center pt-8 text-center px-4">
        <h1 class="text-3xl md:text-4xl font-bold text-purple-700 mb-2 dynapuff">Communities' Choice PB Initiative</h1>
        <h2 class="text-xl md:text-2xl text-purple-600 mb-6 dynapuff">Torfaen Participatory Budgeting</h2>
        <p class="max-w-2xl text-gray-700 arial-nova">
          To vote, please select your area and enter your postcode to verify you are a resident.
        </p>
      </div>

      <!-- Postcode Checker Form -->
      <div class="w-full max-w-lg mx-auto bg-white p-6 sm:p-8 rounded-xl shadow-lg my-8 px-4">
        <h3 class="text-2xl font-bold text-purple-700 mb-6 text-center dynapuff">Postcode Checker</h3>
        <div class="space-y-4">
          <div>
            <label for="area-select" class="block text-sm font-medium text-gray-700 arial-nova mb-1">Select your area:</label>
            <select id="area-select" class="w-full px-3 py-2 text-base text-gray-900 border border-gray-300 rounded-md focus:outline-none focus:ring-purple-500 focus:border-purple-500">
              <option value="">-- Please choose an area --</option>
              <option value="blaenavon">Blaenavon</option>
              <option value="thornhill">Thornhill & Upper Cwmbran</option>
              <option value="trevethin">Trevethin, Penygarn & St. Cadocs</option>
            </select>
          </div>
          <div>
            <label for="postcode-input" class="block text-sm font-medium text-gray-700 arial-nova mb-1">Enter your postcode:</label>
            <input type="text" id="postcode-input" placeholder="e.g., NP4 9AA" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-purple-500 focus:border-purple-500">
          </div>
          <button onclick="checkPostcode()" class="w-full bg-purple-600 hover:bg-purple-800 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition transform hover:scale-105 dynapuff">
            Check & Proceed to Vote
          </button>
        </div>
        <div id="postcode-message" class="mt-4 text-center font-semibold h-6"></div>
      </div>
    </div>

    <!-- LANDING PAGE -->
    <div id="page-landing" class="page">
      <!-- Hero Section -->
      <div class="flex flex-col items-center pt-8 text-center px-4">
        <h1 class="text-3xl md:text-4xl font-bold text-purple-700 mb-2 dynapuff">Explore the Project Areas</h1>
        <p class="max-w-2xl text-gray-700 mb-8 arial-nova">
          Welcome! Residents can explore local projects and vote for their favourite three in their area. Click below to view the projects and cast your votes.
        </p>
      </div>

      <!-- Carousel Section -->
      <div class="flex justify-center items-center pb-12">
        <div class="w-full max-w-2xl px-4">
          <div class="swiper">
            <div class="swiper-wrapper">
              <!-- Blaenavon Slide -->
              <div class="swiper-slide">
                <img src="https://d41chssnpqdne.cloudfront.net/user_upload_by_module/chat_bot/files/970258/DpFwi7NmCYnXBUvt.png?Expires=1758100505&Signature=jlPadhDb87yecaeuDrovOJ8W4vJsM78wL7dATdYb~Zkt-rjx9PP91bnDaKm1C-u3rj3DoMxZgUDTKILX56ulPNA2yxQeA8VZ36ta9nnTM4NuTBB99bYdpFplFIvEQG0kTbbevzinz7tFgt72dKeomgSl1vbtTmewtYr2hKyCb55~Oo-fO-YTIDn7foDO8~N0eilutBg8GkwzGY71zJ8vY0UGGx9UVbVkuVaOVJ4l8943KHfZvxCJii9TQngAMyP~wnuACwcPktNR7gwUwVj64AmLKK-P7kA-P32uG7odsEYus1WKHF5ev0gKGPoJZxfLdBAW23SovTZzeJPz80Yk2w__&Key-Pair-Id=K3USGZIKWMDCSX"
                  alt="Blaenavon Area Map" class="area-img" />
                <h3 class="text-2xl font-semibold text-purple-700 mb-2 dynapuff">Blaenavon</h3>
                <p class="text-gray-700 mb-4 arial-nova">See projects in Blaenavon and vote for your favourite three!</p>
                <button onclick="goToVotePage('blaenavon')" class="bg-purple-600 hover:bg-purple-800 text-white font-bold py-2 px-6 rounded-lg shadow-lg transition transform hover:scale-105 dynapuff">
                  View & Vote
                </button>
              </div>
              <!-- Thornhill & Upper Cwmbran Slide -->
              <div class="swiper-slide">
                <img src="https://d41chssnpqdne.cloudfront.net/user_upload_by_module/chat_bot/files/970258/3joLjVtaze4usLfm.png?Expires=1758100505&Signature=JH8GE9pSMwMt9YML1raWirg7OO5YJmOtMx7JGGF5bbIrsPRrXMmjLi8~g25wZp6kbXSzTzpQuJ-a2-U57GvmUGJ4IeGVH5tzk7f6dixHiSWNb6hKOoli62vf9e12pvgZ8js0SGGboocqur0LzX2SGWSdB9QwXm6FYEN8FWo1aqREudkAD7xMLSAJybTYhd0uTnZ8QGzICl6mkE7vjw9T1dJAEay7lbI4udOth~zbMYusPPSASjwvMKxbVwZfg3heLoj2Ac2dOXhNmfzxsshgYb0p0GLgVtoN89yaP7c68iOJu19sihGt3of2edtTnfqq002vljpRBlhSms-XxDmefw__&Key-Pair-Id=K3USGZIKWMDCSX"
                  alt="Thornhill & Upper Cwmbran Area Map" class="area-img" />
                <h3 class="text-2xl font-semibold text-purple-700 mb-2 dynapuff">Thornhill & Upper Cwmbran</h3>
                <p class="text-gray-700 mb-4 arial-nova">See projects in Thornhill & Upper Cwmbran and vote!</p>
                <button onclick="goToVotePage('thornhill')" class="bg-purple-600 hover:bg-purple-800 text-white font-bold py-2 px-6 rounded-lg shadow-lg transition transform hover:scale-105 dynapuff">
                  View & Vote
                </button>
              </div>
              <!-- Trevethin, Penygarn & St. Cadocs Slide -->
              <div class="swiper-slide">
                <img src="https://d41chssnpqdne.cloudfront.net/user_upload_by_module/chat_bot/files/970258/QJCGbMDvyu4wVjrW.png?Expires=1758100505&Signature=dO2virUuXDAU0UZKzP5LEzc-8hUgGX3qJBUAgjkWl8USaxT~YXr9hTc5xQlfFtvQIQcKPMB7Co2EQ1uPb3n~H1TuDFKL8ieRyXp34-8RLtYmRTToLGc~luAc6vFBdLR9~rygd8GYlbr-FuJdTpbdc-rZa0U6gis3Og7zf0a731~WXeG5S0JJ70V4AnXK-dO5URY5H0ErUWtciVd1faoCcuo6nktLtWii70-C2YsRP207IZxVr9giQrYY5eCJhrdG~9U713Uh5lVJhQHbj1hhqpo1oFspfdv308bODnAKmXNR8JGuCZyfjMMWZODFWMeMMZiA54vDfyrrCNBGT0VyDw__&Key-Pair-Id=K3USGZIKWMDCSX"
                  alt="Trevethin, Penygarn & St Cadocs Area Map" class="area-img" />
                <h3 class="text-2xl font-semibold text-purple-700 mb-2 dynapuff">Trevethin, Penygarn & St. Cadocs</h3>
                <p class="text-gray-700 mb-4 arial-nova">See projects in this area and vote for your favourite three!</p>
                <button onclick="goToVotePage('trevethin')" class="bg-purple-600 hover:bg-purple-800 text-white font-bold py-2 px-6 rounded-lg shadow-lg transition transform hover:scale-105 dynapuff">
                  View & Vote
                </button>
              </div>
            </div>
            <!-- Carousel Navigation -->
            <div class="swiper-pagination"></div>
            <div class="swiper-button-prev"></div>
            <div class="swiper-button-next"></div>
          </div>
        </div>
      </div>
       <!-- Info Section -->
       <div class="max-w-2xl mx-auto mt-12 mb-8 px-4">
        <h3 class="text-lg font-semibold text-purple-700 mb-2 dynapuff">What is Participatory Budgeting?</h3>
        <p class="text-gray-700 mb-4 arial-nova">
          Participatory Budgeting (PB) puts decision-making power in the hands of residents. You can help choose which local projects receive funding by voting for your favourites.
        </p>
        <p class="text-gray-700 arial-nova">
          <strong>How to vote:</strong> Select your area above, verify your postcode, review the project details, and vote for your top three choices. Every vote counts!
        </p>
      </div>
    </div>
    
    <!-- PRIORITIES PAGE -->
    <div id="page-priorities" class="page">
        <div class="w-full max-w-5xl mx-auto my-8 px-4">
            <!-- Hero Section -->
            <div class="text-center mb-10">
              <h1 class="text-3xl md:text-4xl font-bold text-purple-700 mb-2 dynapuff">Our Community Priorities</h1>
              <p class="max-w-3xl mx-auto text-gray-700 arial-nova">
                The 'Have Your Say!' campaign ran from January to May 2025 to identify the top funding priorities for our communities. With <strong>1,062 responses</strong>, your voices have shaped the future of this initiative. Explore the findings for each area below.
              </p>
            </div>

            <!-- Area Tabs -->
            <div class="mb-8 border-b-2 border-gray-200">
                <nav class="-mb-0.5 flex justify-center space-x-2 sm:space-x-6" aria-label="Tabs">
                    <button id="tab-blaenavon" onclick="showPriorityArea('blaenavon')" class="py-4 px-1 sm:px-4 font-semibold text-gray-500 hover:text-purple-700 tab-button dynapuff active">Blaenavon</button>
                    <button id="tab-thornhill" onclick="showPriorityArea('thornhill')" class="py-4 px-1 sm:px-4 font-semibold text-gray-500 hover:text-purple-700 tab-button dynapuff">Thornhill & Upper Cwmbran</button>
                    <button id="tab-trevethin" onclick="showPriorityArea('trevethin')" class="py-4 px-1 sm:px-4 font-semibold text-gray-500 hover:text-purple-700 tab-button dynapuff">Trevethin, Penygarn & St. Cadocs</button>
                </nav>
            </div>
            
            <!-- Content for each area will be injected here -->
            <div id="priorities-content"></div>
        </div>
    </div>

    <!-- DOCUMENTS PAGE -->
    <div id="page-documents" class="page">
      <div class="w-full max-w-4xl mx-auto my-8 px-4">
        <!-- Hero Section -->
        <div class="text-center mb-10">
          <h1 class="text-3xl md:text-4xl font-bold text-purple-700 mb-2 dynapuff">Application Documents Hub</h1>
          <p class="max-w-2xl mx-auto text-gray-700 arial-nova">
            Here you can find all the necessary documents and forms for the Communities' Choice PB Initiative.
          </p>
        </div>
    
        <!-- Part 1 Documents -->
        <div class="mb-12">
          <h2 class="text-2xl md:text-3xl font-bold text-purple-700 mb-6 dynapuff border-b-4 border-purple-300 pb-2">Part 1: Expression of Interest</h2>
          <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Document Card -->
            <a href="https://github.com/DanWTVA-Source/pdf-host/raw/main/PB%201.1%20-%20EOI%20Form%20(Part%201).pdf" download="PB 1.1 - EOI Form (Part 1).pdf" target="_blank" class="block bg-white p-6 rounded-xl shadow-lg hover:shadow-xl hover:-translate-y-1 transition-all duration-300">
              <h3 class="text-xl font-bold text-purple-800 mb-2 dynapuff">PB 1.1 - EOI Form</h3>
              <p class="text-gray-600 arial-nova mb-4">The main Expression of Interest application form (Part 1).</p>
              <span class="inline-flex items-center bg-purple-600 text-white font-semibold py-2 px-4 rounded-lg dynapuff">Download PDF</span>
            </a>
            <!-- Document Card -->
            <a href="https://github.com/DanWTVA-Source/pdf-host/raw/main/PB%201.2%20-%20Our%20Priorities%20Report.pdf" download="PB 1.2 - Our Priorities Report.pdf" target="_blank" class="block bg-white p-6 rounded-xl shadow-lg hover:shadow-xl hover:-translate-y-1 transition-all duration-300">
              <h3 class="text-xl font-bold text-purple-800 mb-2 dynapuff">PB 1.2 - Priorities Report</h3>
              <p class="text-gray-600 arial-nova mb-4">A report detailing the funding priorities identified by the community.</p>
              <span class="inline-flex items-center bg-purple-600 text-white font-semibold py-2 px-4 rounded-lg dynapuff">Download PDF</span>
            </a>
            <!-- Document Card -->
            <a href="https://github.com/DanWTVA-Source/pdf-host/raw/main/PB%201.3%20-%20Application%20Guidance.pdf" download="PB 1.3 - Application Guidance.pdf" target="_blank" class="block bg-white p-6 rounded-xl shadow-lg hover:shadow-xl hover:-translate-y-1 transition-all duration-300">
              <h3 class="text-xl font-bold text-purple-800 mb-2 dynapuff">PB 1.3 - Application Guidance</h3>
              <p class="text-gray-600 arial-nova mb-4">Guidance notes for completing the Part 1 EOI application.</p>
              <span class="inline-flex items-center bg-purple-600 text-white font-semibold py-2 px-4 rounded-lg dynapuff">Download PDF</span>
            </a>
          </div>
        </div>
    
        <!-- Part 2 Documents -->
        <div>
          <h2 class="text-2xl md:text-3xl font-bold text-purple-700 mb-6 dynapuff border-b-4 border-purple-300 pb-2">Part 2: Full Application</h2>
          <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Document Card -->
            <a href="https://github.com/DanWTVA-Source/pdf-host/raw/main/PB%202.1%20-%20Full%20Application%20Form%20(Part%202)%20final.pdf" download="PB 2.1 - Full Application Form (Part 2) final.pdf" target="_blank" class="block bg-white p-6 rounded-xl shadow-lg hover:shadow-xl hover:-translate-y-1 transition-all duration-300">
              <h3 class="text-xl font-bold text-purple-800 mb-2 dynapuff">PB 2.1 - Full Application Form</h3>
              <p class="text-gray-600 arial-nova mb-4">The full, detailed application form for shortlisted projects (Part 2).</p>
              <span class="inline-flex items-center bg-purple-600 text-white font-semibold py-2 px-4 rounded-lg dynapuff">Download PDF</span>
            </a>
            <!-- Document Card -->
            <a href="https://github.com/DanWTVA-Source/pdf-host/raw/main/PB%202.2%20-%20Cross-Area%20Application%20Budget%20Template%20(draft%20v2).pdf" download="PB 2.2 - Cross-Area Application Budget Template (draft v2).pdf" target="_blank" class="block bg-white p-6 rounded-xl shadow-lg hover:shadow-xl hover:-translate-y-1 transition-all duration-300">
              <h3 class="text-xl font-bold text-purple-800 mb-2 dynapuff">PB 2.2 - Budget Template</h3>
              <p class="text-gray-600 arial-nova mb-4">Budget template for applicants applying for funding across multiple areas.</p>
              <span class="inline-flex items-center bg-purple-600 text-white font-semibold py-2 px-4 rounded-lg dynapuff">Download PDF</span>
            </a>
            <!-- Document Card -->
            <a href="https://github.com/DanWTVA-Source/pdf-host/raw/main/PB%202.3%20Peoples%20Committee%20Advisory%20Template.pdf" download="PB 2.3 Peoples Committee Advisory Template.pdf" target="_blank" class="block bg-white p-6 rounded-xl shadow-lg hover:shadow-xl hover:-translate-y-1 transition-all duration-300">
              <h3 class="text-xl font-bold text-purple-800 mb-2 dynapuff">PB 2.3 - Advisory Template</h3>
              <p class="text-gray-600 arial-nova mb-4">Advisory template for the People's Committee assessment process.</p>
              <span class="inline-flex items-center bg-purple-600 text-white font-semibold py-2 px-4 rounded-lg dynapuff">Download PDF</span>
            </a>
            <!-- Document Card -->
            <a href="https://github.com/DanWTVA-Source/pdf-host/raw/main/PB%202.4%20Application%20Guidance%20(Part%202).pdf" download="PB 2.4 Application Guidance (Part 2).pdf" target="_blank" class="block bg-white p-6 rounded-xl shadow-lg hover:shadow-xl hover:-translate-y-1 transition-all duration-300">
              <h3 class="text-xl font-bold text-purple-800 mb-2 dynapuff">PB 2.4 - App. Guidance (P2)</h3>
              <p class="text-gray-600 arial-nova mb-4">Guidance notes for completing the Part 2 full application form.</p>
              <span class="inline-flex items-center bg-purple-600 text-white font-semibold py-2 px-4 rounded-lg dynapuff">Download PDF</span>
            </a>
          </div>
        </div>
      </div>
    </div>

    <!-- TIMELINE PAGE -->
    <div id="page-timeline" class="page">
     <div id="timeline-fullscreen-container">
      <div class="w-full max-w-5xl mx-auto my-8 bg-white rounded-2xl shadow-xl p-6">
        <div class="flex flex-col items-center mb-4 text-center">
          <h1 class="text-2xl md:text-3xl font-bold text-purple-700 mb-1 dynapuff">PB Initiative Timeline</h1>
          <h2 class="text-lg md:text-xl text-purple-600 mb-2 dynapuff">Interactive Timeline of Main Events</h2>
        </div>
        <!-- Timeline -->
        <div class="relative mb-10 group">
          <!-- Timeline Controls -->
          <div class="absolute top-0 right-0 flex space-x-2 z-20">
            <button id="timeline-zoom-in" class="bg-purple-100 text-purple-700 rounded-full w-8 h-8 flex items-center justify-center shadow-md hover:bg-purple-200 transition transform hover:scale-110 disabled:opacity-50 disabled:cursor-not-allowed">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v6m-3-3h6"></path></svg>
            </button>
            <button id="timeline-zoom-out" class="bg-purple-100 text-purple-700 rounded-full w-8 h-8 flex items-center justify-center shadow-md hover:bg-purple-200 transition transform hover:scale-110 disabled:opacity-50 disabled:cursor-not-allowed">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM13 10H7"></path></svg>
            </button>
            <button id="timeline-fullscreen-toggle" class="bg-purple-100 text-purple-700 rounded-full w-8 h-8 flex items-center justify-center shadow-md hover:bg-purple-200 transition transform hover:scale-110">
              <svg id="icon-fullscreen-enter" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 1v4m0 0h-4m4 0l-5-5"></path></svg>
              <svg id="icon-fullscreen-exit" class="w-5 h-5 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 3h6m0 0v6m0-6l-7 7M9 21H3m0 0v-6m0 6l7-7"></path></svg>
            </button>
          </div>

          <div id="timeline-scroll-container" class="overflow-x-auto timeline-scroll pb-4" style="scroll-behavior: smooth;">
            <div class="timeline-bar">
              <div class="timeline-line"></div>
              <!-- Milestones injected by JS -->
              <div id="timeline-callout" class="timeline-callout" style="display: none;"></div>
            </div>
          </div>
           <!-- Custom Navigation Buttons -->
           <button id="timeline-prev" class="absolute top-1/2 left-0 -translate-y-1/2 bg-purple-600 text-white rounded-full w-10 h-10 flex items-center justify-center shadow-lg opacity-0 group-hover:opacity-100 transition-opacity duration-300 transform hover:scale-110 disabled:opacity-50 disabled:cursor-not-allowed z-10">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
          </button>
          <button id="timeline-next" class="absolute top-1/2 right-0 -translate-y-1/2 bg-purple-600 text-white rounded-full w-10 h-10 flex items-center justify-center shadow-lg opacity-0 group-hover:opacity-100 transition-opacity duration-300 transform hover:scale-110 disabled:opacity-50 disabled:cursor-not-allowed z-10">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
          </button>

          <div class="flex justify-center mt-2 text-sm text-gray-500 arial-nova">
            <span>Click any milestone to view details</span>
          </div>
        </div>
      </div>
     </div>
    </div>
    
    <!-- FAQ PAGE -->
    <div id="page-faq" class="page">
      <div class="w-full max-w-4xl mx-auto my-8 px-4">
        <!-- Hero Section -->
        <div class="text-center mb-10">
          <h1 class="text-3xl md:text-4xl font-bold text-purple-700 mb-2 dynapuff">Frequently Asked Questions</h1>
          <p class="max-w-2xl mx-auto text-gray-700 arial-nova">
            Find answers to common questions about the Communities' Choice Fund, the application process, and how you can get involved.
          </p>
        </div>

        <div class="space-y-4">
            <!-- FAQ Item 1 -->
            <details class="faq-item bg-white p-4 rounded-lg shadow-md group">
                <summary class="flex justify-between items-center font-semibold text-purple-800 dynapuff text-lg">
                    What is the Communities' Choice Fund?
                    <span class="icon text-purple-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                    </span>
                </summary>
                <div class="mt-4 text-gray-700 arial-nova space-y-2">
                    <p>The Communities' Choice Fund is a participatory budgeting initiative designed to empower local communities in Blaenavon, Thornhill & Upper Cwmbran, and Trevethin, Penygarn & St. Cadocs. It allows residents to directly decide how public funds are allocated to projects that matter most to them.</p>
                    <p>Its overall objective is to fund initiatives that align with community-identified priorities, promote health and well-being, and contribute to the Well-being of Future Generations (Wales) Act goals. Local People Committees, comprised of community residents, play a crucial role in overseeing project delivery within their areas.</p>
                </div>
            </details>
            <!-- FAQ Item 2 -->
            <details class="faq-item bg-white p-4 rounded-lg shadow-md group">
                <summary class="flex justify-between items-center font-semibold text-purple-800 dynapuff text-lg">
                    What are the key stages of the application process?
                    <span class="icon text-purple-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                    </span>
                </summary>
                <div class="mt-4 text-gray-700 arial-nova space-y-3">
                    <p>The application process is structured in two main parts:</p>
                    <ol class="list-decimal list-inside space-y-2">
                        <li><strong>Part 1: Expression of Interest (EOI) Submission:</strong> Applicants submit an EOI form by <strong>midnight on Friday, August 1st, 2025</strong>.</li>
                        <li><strong>EOI Assessment and Shortlisting:</strong> Local People Committees assess and score eligible EOI forms. Shortlisted applicants are then invited to complete Part 2.</li>
                        <li><strong>Part 2: Full Application Submission:</strong> Invited applicants must submit a detailed application form, project delivery plan, and budget by <strong>11:59 PM on Wednesday, September 10th, 2025</strong>.</li>
                        <li><strong>Final Assessment and Public Vote:</strong> People Committees review Part 2 applications and recommend projects for a public vote. Finalists present their projects at local community voting events where residents directly vote for which projects get funded.</li>
                    </ol>
                </div>
            </details>
             <!-- FAQ Item 3 -->
            <details class="faq-item bg-white p-4 rounded-lg shadow-md group">
                <summary class="flex justify-between items-center font-semibold text-purple-800 dynapuff text-lg">
                    How does the Part 2 application differ from the Part 1 EOI?
                    <span class="icon text-purple-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                    </span>
                </summary>
                <div class="mt-4 text-gray-700 arial-nova space-y-2">
                   <p>The Part 2 Full Application builds significantly on the Part 1 EOI, requiring much greater detail. While Part 1 asks for a project summary and headline budget, Part 2 demands:</p>
                   <ul class="list-disc list-inside space-y-1">
                      <li>A clear project delivery plan with SMART objectives and detailed activities.</li>
                      <li>A realistic and fully justified budget with itemised costs.</li>
                      <li>Specific, practical examples of how the project contributes to the Marmot Principles and Well-being of Future Generations Goals.</li>
                      <li>A risk management plan and details of collaborations.</li>
                      <li>A comprehensive set of supporting documents (e.g., constitutions, policies, bank statements).</li>
                   </ul>
                </div>
            </details>
            <!-- FAQ Item 4 -->
            <details class="faq-item bg-white p-4 rounded-lg shadow-md group">
                <summary class="flex justify-between items-center font-semibold text-purple-800 dynapuff text-lg">
                    What are the funding priorities for each area?
                    <span class="icon text-purple-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                    </span>
                </summary>
                <div class="mt-4 text-gray-700 arial-nova space-y-3">
                  <p>The "Have Your Say!" campaign identified specific priorities for each area. Applicants are strongly encouraged to align their proposals with one or more of these:</p>
                   <div>
                      <h4 class="font-bold text-purple-700">Blaenavon:</h4>
                      <p>Youth Services & Activities, Transport, Antisocial Behaviour, Health & Wellbeing, Environment & Place (Maintenance), and Heritage & Tourism.</p>
                   </div>
                   <div>
                      <h4 class="font-bold text-purple-700">Thornhill & Upper Cwmbran:</h4>
                      <p>Health & Wellbeing, Youth Services & Activities, Environmental Sustainability, Building Stronger Communities, Antisocial Behaviour, and Education & Skills.</p>
                   </div>
                   <div>
                      <h4 class="font-bold text-purple-700">Trevethin, Penygarn & St. Cadocs:</h4>
                      <p>Environment & Place (Maintenance), Youth Services & Activities, Health & Wellbeing, Older People's Activities, Crime & Community Safety, and Education & Skills Development.</p>
                   </div>
                </div>
            </details>
             <!-- FAQ Item 5 -->
            <details class="faq-item bg-white p-4 rounded-lg shadow-md group">
                <summary class="flex justify-between items-center font-semibold text-purple-800 dynapuff text-lg">
                    What if my project covers more than one area?
                    <span class="icon text-purple-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                    </span>
                </summary>
                <div class="mt-4 text-gray-700 arial-nova space-y-2">
                   <p>If your project seeks funding in more than one Communities' Choice Area, you must complete a Cross-Area Application Budget Template (PB 2.2). This requires a separate, detailed budget for each location, specifying local costs like venue hire. Generic or estimated costs are not accepted. The maximum award for a cross-area application is Â£10,000.</p>
                </div>
            </details>
            <!-- FAQ Item 6 -->
            <details class="faq-item bg-white p-4 rounded-lg shadow-md group">
                <summary class="flex justify-between items-center font-semibold text-purple-800 dynapuff text-lg">
                    Who can I contact for help?
                    <span class="icon text-purple-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                    </span>
                </summary>
                <div class="mt-4 text-gray-700 arial-nova space-y-2">
                   <p>For inquiries, please contact the team. Torfaen Voluntary Alliance (TVA) also offers support with required documents and policies.</p>
                   <ul class="list-none space-y-1">
                      <li><strong>Dan Watkins</strong> (Communities' Choice Coordinator): <a href="mailto:dan@tvawales.org.uk" class="text-purple-600 hover:underline">dan@tvawales.org.uk</a></li>
                      <li><strong>Bailey Richardson</strong> (Youth & Community Support Worker): <a href="mailto:bailey@tvawales.org.uk" class="text-purple-600 hover:underline">bailey@tvawales.org.uk</a></li>
                   </ul>
                </div>
            </details>
        </div>

        <div class="mt-12 text-center bg-purple-50 p-6 rounded-lg border-2 border-purple-200">
          <h3 class="text-xl font-bold text-purple-800 mb-2 dynapuff">Still have questions?</h3>
          <p class="text-gray-700 arial-nova">If you can't find the answer you're looking for, please don't hesitate to get in touch with our team.</p>
        </div>
      </div>
    </div>
    
    <!-- VOTING PAGE -->
    <div id="page-voting" class="page">
        <div class="w-full max-w-3xl mx-auto my-8 bg-white rounded-xl shadow-lg p-6">
            <h1 id="voting-title" class="text-2xl md:text-3xl font-bold text-purple-700 mb-2 text-center dynapuff">Voting Page</h1>
            <p id="voting-text" class="text-gray-700 mb-6 text-center arial-nova">
              Please complete the voting form below. Choose your favourite three projects!
            </p>
            <div class="w-full flex justify-center mb-6">
                <iframe id="voting-iframe" src="" width="100%" height="650" style="border: none; border-radius: 0.75rem; box-shadow: 0 2px 10px rgba(80,0,100,0.08);"
                allowfullscreen webkitallowfullscreen mozallowfullscreen msallowfullscreen>
              </iframe>
            </div>
        </div>
    </div>

    <!-- ======================= -->
    <!-- SECURE PORTAL PAGES     -->
    <!-- ======================= -->
    
    <!-- PORTAL LOGIN PAGE -->
    <div id="page-portal-login" class="page">
        <div class="flex flex-col items-center justify-center min-h-[60vh] px-4">
            <div class="w-full max-w-md mx-auto bg-white p-8 rounded-2xl shadow-2xl text-center">
                <img src="https://d41chssnpqdne.cloudfront.net/user_upload_by_module/chat_bot/files/970258/3TRXfqvU6ZSE28wc.png?Expires=1758100204&Signature=CFuWtv9flT3Ad-WcYt5tNM0V0BNmLnq7NC9p~GBlth1SLEsbai8I5oJOPAlXCFNJBoCQ7dxES5RzlKmNqRxjn-VZG62jICHE4ScTtOJWhgsaH5e~ep5ARaaIo7kfHeTCsgUqbVq4NDz-LGQDy0w9~iiOsXTM9JIP8HIPnLvrXmbi9MotBSCkHSvDnrjgNPvH4LAvUTffiwVXrQrPewD7IyiB7UOEYvAqOpf2lL24hk4jfqpXChU-ViIJTOnS8y8xySv6wH5a6ZZTSmxQP4pTa4QQ0w1Zrtrvqd0UVRfI5S9Xwjt8JTLCutwreLhlDDXR~ECwxJ5sNuF5S8bStmQ9MA__&Key-Pair-Id=K3USGZIKWMDCSX" alt="Communities' Choice Logo" class="w-24 mx-auto mb-4"/>
                <h1 class="text-3xl font-bold text-purple-700 mb-2 dynapuff">Committee Portal Login</h1>
                <p class="text-gray-600 mb-6">Please enter your credentials to access the portal.</p>
                <div class="space-y-4">
                    <input type="text" id="login-username" placeholder="Username (e.g. jsmith)" class="w-full px-4 py-2 border-2 border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                    <input type="password" id="login-password" placeholder="Password" class="w-full px-4 py-2 border-2 border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                    <button onclick="login()" class="w-full bg-purple-600 hover:bg-purple-800 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition transform hover:scale-105 dynapuff">
                        Login
                    </button>
                </div>
                 <p id="login-message" class="mt-4 text-center font-semibold text-red-600 h-6"></p>
            </div>
        </div>
    </div>
    
    <!-- ADMIN DASHBOARD -->
    <div id="page-admin-dashboard" class="portal-page">
         <div class="w-full max-w-7xl mx-auto my-8 px-4">
            <div class="text-center mb-10">
              <h1 class="text-3xl md:text-4xl font-bold text-purple-700 mb-2 dynapuff">Administrator Dashboard</h1>
              <p class="max-w-3xl mx-auto text-gray-700 arial-nova">
                Oversight of all People's Committee scoring activities.
              </p>
            </div>
            <div class="mb-6 bg-white p-4 rounded-xl shadow-md">
                <label for="admin-area-filter" class="block text-sm font-medium text-gray-700 mb-1">Filter by Area:</label>
                <select id="admin-area-filter" class="w-full max-w-xs p-2 border border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500">
                    <option value="All">All Areas</option>
                    <option value="Blaenavon">Blaenavon</option>
                    <option value="Thornhill & Upper Cwmbran">Thornhill & Upper Cwmbran</option>
                    <option value="Trevethin, Penygarn & St. Cadocs">Trevethin, Penygarn & St. Cadocs</option>
                </select>
            </div>
            <div id="admin-dashboard-content" class="space-y-8">
                <!-- Admin dashboard content will be injected here -->
            </div>
        </div>
    </div>

    <!-- PORTAL DASHBOARD (Regular Member) -->
    <div id="page-portal-dashboard" class="portal-page">
         <div class="w-full max-w-5xl mx-auto my-8 px-4">
            <!-- Hero Section -->
            <div class="text-center mb-10">
              <h1 class="text-3xl md:text-4xl font-bold text-purple-700 mb-2 dynapuff">People's Committee Portal</h1>
              <p class="max-w-3xl mx-auto text-gray-700 arial-nova">
                Welcome. This is your central hub for scoring applications, viewing submitted documents, and accessing committee resources.
              </p>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                <!-- Card 1: Scoring Matrix -->
                <div onclick="showPortalPage('page-scoring')" class="bg-white p-8 rounded-2xl shadow-lg hover:shadow-2xl hover:-translate-y-2 transition-all duration-300 cursor-pointer text-center">
                    <div class="bg-purple-100 text-purple-600 rounded-full w-16 h-16 flex items-center justify-center mx-auto mb-4">
                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg>
                    </div>
                    <h2 class="text-2xl font-bold text-purple-800 mb-2 dynapuff">Scoring Matrix</h2>
                    <p class="text-gray-600 arial-nova">Access the official tool to assess and score all submitted applications.</p>
                </div>
                <!-- Card 2: Applications Viewer -->
                <div onclick="showPortalPage('page-portal-apps')" class="bg-white p-8 rounded-2xl shadow-lg hover:shadow-2xl hover:-translate-y-2 transition-all duration-300 cursor-pointer text-center">
                     <div class="bg-teal-100 text-teal-600 rounded-full w-16 h-16 flex items-center justify-center mx-auto mb-4">
                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a4 4 0 014-4h6a4 4 0 014 4v12a4 4 0 01-4 4H7zM10 12h4"></path></svg>
                    </div>
                    <h2 class="text-2xl font-bold text-purple-800 mb-2 dynapuff">Applications Viewer</h2>
                    <p class="text-gray-600 arial-nova">View and read all the submitted application PDF documents.</p>
                </div>
                <!-- Card 3: Documents Hub -->
                <div onclick="showPortalPage('page-portal-docs')" class="bg-white p-8 rounded-2xl shadow-lg hover:shadow-2xl hover:-translate-y-2 transition-all duration-300 cursor-pointer text-center">
                    <div class="bg-purple-100 text-purple-600 rounded-full w-16 h-16 flex items-center justify-center mx-auto mb-4">
                         <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path></svg>
                    </div>
                    <h2 class="text-2xl font-bold text-purple-800 mb-2 dynapuff">Documents & Hub</h2>
                    <p class="text-gray-600 arial-nova">Find committee-specific documents, meeting minutes, and guidance.</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- PORTAL: SCORING MATRIX -->
    <div id="page-scoring" class="portal-page">
        <div class="w-full max-w-7xl mx-auto my-8 px-4">
            <div class="flex flex-wrap justify-between items-center mb-6 gap-4">
                 <button class="back-to-dashboard inline-flex items-center text-purple-700 hover:text-purple-900 font-semibold transition-colors">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                    Back to Portal Dashboard
                </button>
                 <button onclick="openGuideModal()" class="inline-flex items-center bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition transform hover:scale-105">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    View User Guide
                </button>
            </div>
            <!-- Hero Section -->
            <div class="text-center mb-10">
                <h1 class="text-3xl md:text-4xl font-bold text-purple-700 mb-2 dynapuff">People's Committee Scoring Matrix</h1>
                <p class="max-w-3xl mx-auto text-gray-700 arial-nova">
                    Use this tool to score applications based on the agreed criteria. Your scores are saved in real-time.
                </p>
            </div>

            <div class="bg-white p-4 sm:p-6 rounded-2xl shadow-2xl">
                 <div id="scoring-finalized-message" class="hidden mb-4 p-4 text-center font-semibold text-blue-800 bg-blue-100 border border-blue-200 rounded-lg"></div>
                <!-- Header Controls -->
                <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-3 gap-4 mb-6 pb-6 border-b border-gray-200">
                    <div>
                        <label for="scoring-ref" class="block text-sm font-medium text-gray-700 mb-1">PB Reference</label>
                        <select id="scoring-ref" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500"></select>
                    </div>
                    <div>
                        <label for="scoring-applicant" class="block text-sm font-medium text-gray-700 mb-1">Applicant</label>
                        <select id="scoring-applicant" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500"></select>
                    </div>
                    <div>
                        <label for="scoring-area" class="block text-sm font-medium text-gray-700 mb-1">Area</label>
                        <input type="text" id="scoring-area" class="w-full p-2 border border-gray-300 rounded-md bg-gray-100" readonly>
                    </div>
                </div>

                 <!-- View PDF Button -->
                <div class="mb-6 text-center">
                    <button id="view-pdf-button" class="bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-5 rounded-lg shadow transition disabled:opacity-50 disabled:cursor-not-allowed" disabled>View Application PDF</button>
                </div>


                <!-- Scoring Table -->
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200 scoring-table">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="text-left text-xs font-medium text-gray-500 uppercase tracking-wider dynapuff">Criterion</th>
                                <th class="text-left text-xs font-medium text-gray-500 uppercase tracking-wider dynapuff">Guidance</th>
                                <th class="text-left text-xs font-medium text-gray-500 uppercase tracking-wider dynapuff" style="min-width: 150px;">Score</th>
                                <th class="text-left text-xs font-medium text-gray-500 uppercase tracking-wider dynapuff" style="min-width: 250px;">Notes & Justification</th>
                            </tr>
                        </thead>
                        <tbody id="scoring-matrix-body" class="bg-white divide-y divide-gray-200"></tbody>
                    </table>
                </div>

                <!-- Totals & Outcome -->
                <div class="mt-6 pt-6 border-t border-gray-200 flex flex-wrap justify-between items-center gap-4">
                    <div class="flex items-center space-x-4">
                        <h3 class="text-lg font-bold text-gray-800 dynapuff">Total Score:</h3>
                        <span id="scoring-total" class="text-2xl font-bold text-purple-700">0 / 100</span>
                    </div>
                     <div class="flex items-center space-x-4">
                        <h3 class="text-lg font-bold text-gray-800 dynapuff">Outcome:</h3>
                        <span id="scoring-outcome" class="px-4 py-1 text-lg font-bold text-white rounded-full"></span>
                    </div>
                    <div class="flex items-center space-x-2">
                         <label for="scoring-threshold" class="text-sm font-medium text-gray-700">Threshold:</label>
                         <input id="scoring-threshold" type="number" value="65" class="w-20 p-2 border border-gray-300 rounded-md shadow-sm">
                    </div>
                </div>
                
                 <!-- Actions & Task List -->
                <div class="mt-6 pt-6 border-t border-gray-200 grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div>
                         <h3 class="text-xl font-bold text-gray-800 mb-4 dynapuff">Actions & Export</h3>
                        <div class="flex flex-wrap gap-3">
                            <button id="scoring-post-final" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg shadow transition">Post Final Scores</button>
                            <button id="scoring-export-csv" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg shadow transition admin-only" style="display: none;">Export Master CSV</button>
                            <button id="scoring-clear" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg shadow transition">Clear Current Form</button>
                        </div>
                         <p id="scoring-status" class="text-sm text-gray-500 mt-3 h-4"></p>
                    </div>
                    <div id="task-list-container">
                        <h3 class="text-xl font-bold text-gray-800 mb-4 dynapuff">My Scoring Tasks</h3>
                        <div id="task-list-content" class="bg-gray-50 p-2 rounded-lg h-48 overflow-y-auto space-y-1">
                            <p class="text-gray-500 p-2">Loading tasks...</p>
                        </div>
                         <div id="task-list-summary" class="mt-2"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- PORTAL: APPLICATIONS VIEWER -->
    <div id="page-portal-apps" class="portal-page">
         <div class="w-full max-w-7xl mx-auto my-8 px-4">
              <button class="back-to-dashboard mb-6 inline-flex items-center text-purple-700 hover:text-purple-900 font-semibold transition-colors">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                Back to Portal Dashboard
            </button>
            <div class="text-center mb-10">
                <h1 class="text-3xl md:text-4xl font-bold text-purple-700 mb-2 dynapuff">Application Viewer</h1>
                <p class="max-w-3xl mx-auto text-gray-700 arial-nova">
                    Select an application from the list to view the submitted PDF.
                </p>
            </div>
            
            <div class="lg:flex lg:space-x-8">
                <div class="lg:w-1/3 bg-white p-4 rounded-xl shadow-lg mb-6 lg:mb-0">
                    <h3 class="text-lg font-bold text-purple-700 dynapuff mb-2">My Applications</h3>
                     <div id="app-viewer-list" class="h-[70vh] overflow-y-auto space-y-2 pr-2">
                        <p class="text-gray-500 text-center p-4">Loading applications...</p>
                     </div>
                </div>
                <div class="lg:w-2/3">
                    <div id="app-viewer-display" class="bg-white p-4 rounded-xl shadow-lg h-[75vh] flex flex-col items-center justify-center text-gray-500">
                        <!-- PDF will be shown here -->
                         <svg class="w-16 h-16 mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                         <p>Select an application from the list to view it.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- PORTAL: DOCUMENTS HUB -->
    <div id="page-portal-docs" class="portal-page">
         <div class="w-full max-w-4xl mx-auto my-8 px-4">
               <button class="back-to-dashboard mb-6 inline-flex items-center text-purple-700 hover:text-purple-900 font-semibold transition-colors">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                Back to Portal Dashboard
            </button>
            <div class="text-center mb-10">
              <h1 class="text-3xl md:text-4xl font-bold text-purple-700 mb-2 dynapuff">Committee Documents & Hub</h1>
              <p class="max-w-2xl mx-auto text-gray-700 arial-nova">
                A central repository for all essential documents for People's Committee members.
              </p>
            </div>
            <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                 <a href="#" class="block bg-white p-6 rounded-xl shadow-lg hover:shadow-xl hover:-translate-y-1 transition-all duration-300">
                    <h3 class="text-xl font-bold text-purple-800 mb-2 dynapuff">Scoring Guidance</h3>
                    <p class="text-gray-600 arial-nova mb-4">Detailed breakdown of the scoring matrix and criteria.</p>
                    <span class="inline-flex items-center bg-purple-600 text-white font-semibold py-2 px-4 rounded-lg dynapuff">Download PDF</span>
                 </a>
                 <a href="#" class="block bg-white p-6 rounded-xl shadow-lg hover:shadow-xl hover:-translate-y-1 transition-all duration-300">
                    <h3 class="text-xl font-bold text-purple-800 mb-2 dynapuff">Committee Contact List</h3>
                    <p class="text-gray-600 arial-nova mb-4">Contact details for all members of the People's Committee.</p>
                    <span class="inline-flex items-center bg-purple-600 text-white font-semibold py-2 px-4 rounded-lg dynapuff">Download PDF</span>
                 </a>
                 <a href="#" class="block bg-white p-6 rounded-xl shadow-lg hover:shadow-xl hover:-translate-y-1 transition-all duration-300">
                    <h3 class="text-xl font-bold text-purple-800 mb-2 dynapuff">Meeting Agendas & Minutes</h3>
                    <p class="text-gray-600 arial-nova mb-4">Access all past and upcoming meeting agendas and minutes.</p>
                    <span class="inline-flex items-center bg-purple-600 text-white font-semibold py-2 px-4 rounded-lg dynapuff">View Folder</span>
                 </a>
            </div>
        </div>
    </div>

    <!-- PORTAL: ADMIN MASTER TRACKER -->
    <div id="page-portal-tracker" class="portal-page admin-only">
         <div id="master-tracker-content" class="w-full max-w-7xl mx-auto my-8 px-4">
               <button class="back-to-dashboard mb-6 inline-flex items-center text-purple-700 hover:text-purple-900 font-semibold transition-colors">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                Back to Portal Dashboard
            </button>
             <div class="text-center mb-10">
              <h1 class="text-3xl md:text-4xl font-bold text-purple-700 mb-2 dynapuff">Master Scoring Tracker</h1>
             </div>
             <div id="master-tracker-view" class="bg-white p-6 rounded-2xl shadow-xl"></div>
         </div>
    </div>

    <!-- Draggable & Resizable PDF Viewer Window -->
    <div id="pdf-viewer-window" class="hidden fixed top-20 left-10 w-[50vw] h-[75vh] bg-white rounded-lg shadow-2xl flex flex-col border-2 border-purple-200 resize overflow-hidden" style="min-width: 400px; min-height: 500px;">
        <div id="pdf-viewer-header" class="flex justify-between items-center p-2 bg-gray-100 border-b cursor-move">
            <h3 id="pdf-viewer-title" class="text-lg font-bold text-gray-800 dynapuff truncate pl-2">Application Viewer</h3>
            <button onclick="closePdfViewer()" class="text-gray-500 hover:text-red-600 p-1 rounded-full">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
        <div class="flex-grow p-1 bg-gray-200">
            <iframe id="pdf-viewer-iframe" class="w-full h-full border-0" title="PDF viewer"></iframe>
        </div>
    </div>

    <!-- User Guide Modal -->
    <div id="guide-modal" onclick="event.target === this && closeGuideModal()" class="hidden fixed inset-0 bg-black bg-opacity-60 z-[1002] flex items-center justify-center p-4 transition-opacity duration-300">
        <div class="bg-white w-full max-w-3xl max-h-[90vh] rounded-2xl shadow-2xl p-6 sm:p-8 flex flex-col">
            <div class="flex justify-between items-center border-b border-gray-200 pb-3 mb-4">
                <h2 class="text-2xl font-bold text-purple-700 dynapuff">Scoring Matrix User Guide</h2>
                 <button onclick="closeGuideModal()" class="text-gray-400 hover:text-red-600 hover:bg-red-100 p-1 rounded-full transition-colors">
                    <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div class="overflow-y-auto pr-4 space-y-4 text-left arial-nova text-gray-700">
                 <p class="text-lg">Welcome to the People's Committee Scoring Matrix. This guide will walk you through the process of scoring applications for the Communities' Choice Fund.</p>
                <div>
                    <h3 class="font-bold text-lg text-purple-800 dynapuff mt-4">Step 1: Choose an Application to Score</h3>
                    <p>You can select an application in two ways:</p>
                    <ul class="list-disc list-inside ml-4 mt-2 space-y-1">
                        <li>Use the 'PB Reference' or 'Applicant' dropdown menus.</li>
                        <li>Click on an application directly from your 'My Scoring Tasks' list on the right. This is the recommended way to work through your assigned applications.</li>
                    </ul>
                </div>

                <div>
                    <h3 class="font-bold text-lg text-purple-800 dynapuff mt-4">Step 2: Score the Application</h3>
                    <p>Once an application is loaded, you can begin scoring:</p>
                    <ul class="list-disc list-inside ml-4 mt-2 space-y-1">
                        <li><strong>Read the Application:</strong> Click the 'View Application PDF' button to open the applicant's PDF in a movable window.</li>
                        <li><strong>Use the Sliders:</strong> For each criterion, use the slider to select a score from 0 to 3. Your total score will update automatically.</li>
                        <li><strong>Add Notes (Optional):</strong> You can add notes in the text box to provide context or justification for the score you have given for each criterion. Your progress is saved automatically.</li>
                        <li><strong>Guidance:</strong> Hover over the <svg class="inline-block w-5 h-5 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg> icon next to each criterion name for detailed scoring guidance.</li>
                    </ul>
                </div>

                <div>
                    <h3 class="font-bold text-lg text-purple-800 dynapuff mt-4">Step 3: Submitting Your Final Scores</h3>
                    <p>When you are completely happy with your scores and justification for an application and are ready to submit them, click the <strong>'Post Final Scores'</strong> button. You will be asked to confirm this action.</p>
                    <p class="font-semibold text-red-600 mt-2">Important: Once you post your scores, you will NOT be able to edit them again. The form for that application will become read-only.</p>
                </div>
            </div>
        </div>
    </div>
  </main>
  
  <!-- Firebase SDK -->
  <script type="module">
    // Import Firebase modules
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { 
        getAuth, 
        onAuthStateChanged, 
        signInWithEmailAndPassword,
        signOut 
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { 
        getFirestore, 
        setLogLevel,
        doc, 
        getDoc, 
        setDoc, 
        deleteDoc, 
        collection, 
        onSnapshot, 
        query, 
        where 
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // ---------------
    // DATA
    // ---------------
    const areaData = {
      'blaenavon': {
          name: 'Blaenavon',
          formUrl: 'https://forms.office.com/e/FTQ4s8EK84',
          postcodes: ["NP49AA","NP49AB","NP49AD","NP49AE","NP49AF","NP49AG","NP49AH","NP49AJ","NP49AL","NP49AN","NP49AP","NP49AQ","NP49AR","NP49AS","NP49AT","NP49AU","NP49AW","NP49AX","NP49AY","NP49AZ","NP49BA","NP49BB","NP49BD","NP49BE","NP49BG","NP49BH","NP49BJ","NP49BL","NP49BN","NP49BP","NP49BQ","NP49BS","NP49BT","NP49BU","NP49BW","NP49BX","NP49BY","NP49BZ","NP49DA","NP49DB","NP49DD","NP49DE","NP49DF","NP49DG","NP49DH","NP49DJ","NP49DL","NP49DN","NP49DP","NP49DQ","NP49DR","NP49DS","NP49DT","NP49DU","NP49DW","NP49DX","NP49DY","NP49DZ","NP49EA","NP49EB","NP49ED","NP49EE","NP49EF","NP49EG","NP49EH","NP49EJ","NP49EL","NP49EN","NP49EP","NP49EQ","NP49ER","NP49ES","NP49ET","NP49EU","NP49EW","NP49EX","NP49EY","NP49EZ","NP49FA","NP49FB","NP49FD","NP49FE","NP49FF","NP49FG","NP49FH","NP49FJ","NP49FL","NP49FN","NP49FP","NP49FQ","NP49FR","NP49FS","NP49FT","NP49FU","NP49FW","NP49FX","NP49FY","NP49FZ","NP49GA","NP49GB","NP49GD","NP49GE","NP49GF","NP49GG","NP49GH","NP49GJ","NP49GL","NP49GN","NP49GP","NP49GQ","NP49GR","NP49GS","NP49GT","NP49GU","NP49GW","NP49GX","NP49GY","NP49GZ","NP49HA","NP49HB","NP49HD","NP49HE","NP49HF","NP49HG","NP49HH","NP49HJ","NP49HL","NP49HN","NP49HP","NP49HQ","NP49HR","NP49HS","NP49HT","NP49HU","NP49HW","NP49HX","NP49HY","NP49HZ","NP49JA","NP49JB","NP49JD","NP49JE","NP49JF","NP49JG","NP49JH","NP49JJ","NP49JL","NP49JN","NP49JP","NP49JQ","NP49JR","NP49JS","NP49JT","NP49JU","NP49JW","NP49JX","NP49JY","NP49JZ","NP49LA","NP49LB","NP49LD","NP49LE","NP49LF","NP49LG","NP49LH","NP49LJ","NP49LL","NP49LN","NP49LP","NP49LQ","NP49LR","NP49LS","NP49LT","NP49LU","NP49LW","NP49LX","NP49LY","NP49LZ","NP49NA","NP49NB","NP49ND","NP49NE","NP49NF","NP49NG","NP49NH","NP49NL","NP49NN","NP49NP","NP49NQ","NP49NR","NP49NS","NP49NT","NP49NU","NP49NW","NP49NX","NP49NY","NP49NZ","NP49PA","NP49PB","NP49PD","NP49PE","NP49PF","NP49PG","NP49PH","NP49PJ","NP49PL","NP49PN","NP49PP","NP49PQ","NP49PR","NP49PS","NP49PT","NP49PU","NP49PW","NP49PX","NP49PY","NP49PZ","NP49QA","NP49QB","NP49QD","NP49QE","NP49QF","NP49QG","NP49QH","NP49QJ","NP49QL","NP49QN","NP49QP","NP49QQ","NP49QR","NP49QS","NP49QT","NP49QU","NP49QW","NP49QX","NP49QY","NP49QZ","NP49RA","NP49RB","NP49RD","NP49RE","NP49RF","NP49RG","NP49RH","NP49RJ","NP49RL","NP49RN","NP49RP","NP49RQ","NP49RR","NP49RS","NP49RT","NP49RU","NP49RW","NP49RX","NP49RY","NP49RZ","NP49SA","NP49SB","NP49SD","NP49SE","NP49SF","NP49SG","NP49SJ","NP49SR"]
      },
      'thornhill': {
          name: 'Thornhill & Upper Cwmbran',
          formUrl: 'https://forms.office.com/e/n0jg5xdAwS',
          postcodes: ["NP45DQ","NP441AB","NP441AY","NP441AZ","NP441BA","NP441BE","NP441BG","NP441BH","NP441BJ","NP441BL","NP441BN","NP441BP","NP441BS","NP441BT","NP441BU","NP441BW","NP441BX","NP441BY","NP441BZ","NP441DA","NP441DB","NP441DE","NP441DF","NP441DG","NP441DH","NP441DJ","NP441DL","NP441DN","NP441DP","NP441DQ","NP441DR","NP441DS","NP441DT","NP441DU","NP441DW","NP441DX","NP441DY","NP441DZ","NP441EA","NP441EB","NP441ED","NP441EE","NP441EF","NP441EG","NP441EH","NP441EL","NP441EN","NP441EP","NP441EQ","NP441ER","NP441ES","NP441ET","NP441EU","NP441EW","NP441EX","NP441EY","NP441EZ","NP441HA","NP441HB","NP441HD","NP441HE","NP441HF","NP441HG","NP441HH","NP441HJ","NP441HL","NP441HN","NP441HP","NP441HQ","NP441HR","NP441HS","NP441HT","NP441HU","NP441HW","NP441HX","NP441HY","NP441HZ","NP441JA","NP441JB","NP441JD","NP441JE","NP441JF","NP441JG","NP441JH","NP441JJ","NP441JL","NP441JN","NP441JP","NP441JR","NP441JS","NP441JT","NP441JU","NP441JX","NP441LA","NP441LB","NP441LD","NP441LE","NP441LG","NP441LH","NP441LJ","NP441LL","NP441LN","NP441LP","NP441LQ","NP441LR","NP441LS","NP441LT","NP441LU","NP441LW","NP441LX","NP441NA","NP441NB","NP441ND","NP441NE","NP441NF","NP441NG","NP441NH","NP441NJ","NP441NL","NP441NN","NP441NP","NP441NQ","NP441NR","NP441NS","NP441NT","NP441NU","NP441NW","NP441PA","NP441PB","NP441PD","NP441PE","NP441PF","NP441PG","NP441PH","NP441PJ","NP441PL","NP441PN","NP441PP","NP441PQ","NP441PR","NP441PS","NP441PT","NP441PU","NP441PW","NP441PX","NP441PY","NP441PZ","NP441QA","NP441QB","NP441QD","NP441QE","NP441QF","NP441QG","NP441QH","NP441QJ","NP441QL","NP441QP","NP441QQ","NP441QR","NP441QS","NP441QT","NP441QU","NP441QW","NP441QX","NP441QY","NP441QZ","NP441RA","NP441RB","NP441RD","NP441RE","NP441RF","NP441RG","NP441RH","NP441RJ","NP441RL","NP441RN","NP441RP","NP441RQ","NP441RR","NP441RS","NP441RT","NP441RU","NP441RW","NP441RX","NP441RY","NP441RZ","NP441SA","NP441SB","NP441SD","NP441SE","NP441SF","NP441SG","NP441SH","NP441SJ","NP441SL","NP441SN","NP441SP","NP441SQ","NP441SR","NP441SS","NP441ST","NP441SU","NP441SW","NP441SX","NP441SY","NP441SZ","NP441TA","NP441TB","NP441TD","NP441TE","NP441TF","NP441TG","NP441TH","NP441TJ","NP441TL","NP441TN","NP441TP","NP441TQ","NP441TR","NP441TS","NP441TT","NP441TU","NP441TW","NP441TX","NP441TY","NP441UA","NP441WA","NP441WB","NP442EB","NP442RX","NP442SB","NP444TQ","NP445AA","NP445AB","NP445AD","NP445AE","NP445AF","NP445AG","NP445AH","NP445AJ","NP445AL","NP445AN","NP445AP","NP445AQ","NP445AR","NP445AS","NP445AT","NP445AU","NP445AW","NP445AX","NP445AY","NP445AZ","NP445BA","NP445BB","NP445BD","NP445BE","NP445BF","NP445BG","NP445BH","NP445BJ","NP445BL","NP445BN","NP445BP","NP445BQ","NP445BS","NP445BT","NP445BU","NP445BW","NP445BX","NP445BY","NP445BZ","NP445DA","NP445DB","NP445DD","NP445DE","NP445DF","NP445DG","NP445DH","NP445DJ","NP445DL","NP445DN","NP445DP","NP445DQ","NP445DR","NP445DS","NP445DT","NP445DU","NP445DW","NP445DX","NP445DY","NP445DZ","NP445EA","NP445EB","NP445ED","NP445EE","NP445EF","NP445EG","NP445EH","NP445EJ","NP445EL","NP445EN","NP445EP","NP445EQ","NP445ER","NP445ES","NP445ET","NP445EU","NP445EW","NP445EX","NP445EY","NP445EZ","NP445FA","NP445FB","NP445FD","NP445FE","NP445FF","NP445FG","NP445FH","NP445FJ","NP445FL","NP445FN","NP445FP","NP445FQ","NP445FR","NP445FS","NP445FT","NP445FU","NP445HA","NP445HB","NP445HD","NP445HE","NP445HF","NP445HG","NP445HH","NP445HJ","NP445HL","NP445HN","NP445HP","NP445HQ","NP445HR","NP445HS","NP445HT","NP445HU","NP445HW","NP445HX","NP445HY","NP445HZ","NP445JA","NP445JB","NP445JD","NP445JE","NP445JF","NP445JG","NP445JH","NP445JJ","NP445JL","NP445JN","NP445JP","NP445JQ","NP445JR","NP445JS","NP445JT","NP445JU","NP445JW","NP445JX","NP445JY","NP445JZ","NP445LA","NP445LB","NP445LD","NP445LE","NP445LF","NP445LG","NP445LH","NP445LJ","NP445LL","NP445LN","NP445LP","NP445LQ","NP445LR","NP445LS","NP445LT","NP445LU","NP445LW","NP445LX","NP445LY","NP445LZ","NP445NA","NP445NB","NP445ND","NP445NE","NP445NF","NP445NG","NP445NH","NP445NJ","NP445NL","NP445NN","NP445NP","NP445NQ","NP445NR","NP445NS","NP445NT","NP445NU","NP445NW","NP445NX","NP445NY","NP445NZ","NP445PA","NP445PB","NP445PD","NP445PE","NP445PF","NP445PG","NP445PH","NP445PJ","NP445PL","NP445PN","NP445PP","NP445PQ","NP445PR","NP445PS","NP445PT","NP445PU","NP445PW","NP445PX","NP445PY","NP445PZ","NP445QA","NP445QB","NP445QD","NP445QE","NP445QF","NP445QG","NP445QH","NP445QJ","NP445QL","NP445QN","NP445QP","NP445QQ","NP445QR","NP445QS","NP445QT","NP445QU","NP445QW","NP445QX","NP445QY","NP445QZ","NP445RA","NP445RB","NP445RD","NP445RE","NP445RF","NP445RG","NP445RH","NP445RJ","NP445RL","NP445RN","NP445RP","NP445RQ","NP445RR","NP445RS","NP445RT","NP445RU","NP445RW","NP445RX","NP445RY","NP445SA","NP445SB","NP445SD","NP445SE","NP445SF","NP445SG","NP445SH","NP445SJ","NP445SL","NP445SN","NP445SP","NP445SQ","NP445SR","NP445SS","NP445ST","NP445SU","NP445SW","NP445SX","NP445SY","NP445TA","NP445TB","NP445TD","NP445TE","NP445TF","NP445TG","NP445TH","NP445TJ","NP445TL","NP445TN","NP445TP","NP445TQ","NP445TR","NP445TS","NP445TT","NP445TU","NP445TW","NP445TX","NP445TY","NP445TZ","NP445UA","NP445UB","NP445UD","NP445UE","NP445UF","NP445UG","NP445UH","NP445UJ","NP445UL","NP445UN","NP445UP","NP445UQ","NP445UR","NP445US","NP445UT","NP445UU","NP445UW","NP445UX","NP445UY"]
      },
      'trevethin': {
          name: 'Trevethin, Penygarn & St. Cadocs',
          formUrl: 'https://forms.office.com/e/ZAhvh5VnEg',
          postcodes: ["NP46TB","NP46TE","NP46TF","NP46TL","NP48AX","NP48BB","NP48BD","NP48BG","NP48BN","NP48BP","NP48BQ","NP48BR","NP48BS","NP48BT","NP48BU","NP48BW","NP48BX","NP48BY","NP48BZ","NP48DA","NP48DD","NP48DG","NP48DH","NP48DJ","NP48DL","NP48DN","NP48DP","NP48DQ","NP48DR","NP48DS","NP48DT","NP48DU","NP48DW","NP48DX","NP48DY","NP48DZ","NP48EA","NP48EB","NP48ED","NP48EE","NP48EF","NP48EG","NP48EH","NP48EJ","NP48EL","NP48EN","NP48EP","NP48EW","NP48EY","NP48EZ","NP48FD","NP48GA","NP48HA","NP48HB","NP48HD","NP48HE","NP48HF","NP48HG","NP48HH","NP48HJ","NP48HL","NP48HP","NP48HQ","NP48HR","NP48HS","NP48HT","NP48HU","NP48HW","NP48HX","NP48HY","NP48HZ","NP48JA","NP48JB","NP48JD","NP48JE","NP48JF","NP48JG","NP48JH","NP48JJ","NP48JL","NP48JN","NP48JP","NP48JQ","NP48JR","NP48JS","NP48JT","NP48JU","NP48JW","NP48JX","NP48JY","NP48JZ","NP48LA","NP48LB","NP48LD","NP48LE","NP48LF","NP48LG","NP48LH","NP48LJ","NP48LL","NP48LN","NP48LP","NP48LQ","NP48LR","NP48LS","NP48LT","NP48LU","NP48LW","NP48LX","NP48LY","NP48NA","NP48NB","NP48ND","NP48NE","NP48NF","NP48NG","NP48NH","NP48NJ","NP48NL","NP48NN","NP48NP","NP48NQ","NP48NR","NP48NS","NP48NT","NP48NU","NP48NW","NP48NX","NP48NY","NP48PA","NP48PB","NP48PD","NP48PE","NP48PF","NP48PG","NP48PH","NP48PJ","NP48PL","NP48PN","NP48PP","NP48PQ","NP48PR","NP48PS","NP48PT","NP48PU","NP48PW","NP48PX","NP48PY","NP48PZ","NP48QA","NP48QB","NP48QD","NP48QE","NP48QF","NP48QG","NP48QH","NP48QJ","NP48QL","NP48QN","NP48QP","NP48QQ","NP48QR","NP48QS","NP48QT","NP48QU","NP48QW","NP48QX","NP48QY","NP48RA","NP48RB","NP48RD","NP48RE","NP48RF","NP48RG","NP48RH","NP48RJ","NP48RL","NP48RN","NP48RP","NP48RQ","NP48RR","NP48RS","NP48RT","NP48RU","NP48RW","NP48RX","NP48RY","NP48RZ","NP48SA","NP48SB","NP48SD","NP48SE","NP48SF","NP48SG","NP48SH","NP48SJ","NP48SL","NP48SN","NP48SP","NP48SQ","NP48SR","NP48SS","NP48ST","NP48SU","NP48SW","NP48SX","NP48SY","NP48SZ","NP48TA","NP48TB","NP48TD","NP48TE","NP48TF","NP48TG","NP48TH","NP48TJ","NP48TL","NP48TN","NP48TP","NP48TQ","NP48TR","NP48TS","NP48TT","NP48TU","NP48TW","NP48TX","NP48TY","NP48TZ","NP48UA","NP48UB","NP48UD","NP48UE","NP48UF","NP48UG","NP48UH","NP48UJ","NP48UL","NP48UN","NP48UP","NP48UQ","NP48UR","NP48UT","NP48UU","NP48UW","NP48UX","NP48UY","NP48UZ","NP48WA","NP48WB","NP48WD","NP48WE","NP48WF","NP48WG","NP48WH","NP48WJ","NP48WL","NP48WN","NP48WP","NP48WQ","NP48WR","NP48WS","NP48WT","NP48WU","NP48WW","NP48WX","NP48WY","NP48WZ","NP48XA","NP48XB","NP48XD","NP48XF","NP48XG","NP48XH","NP48XJ","NP48XL","NP48XN","NP48XP","NP48XQ","NP48XR","NP48XS","NP48XT","NP48XU","NP48XW","NP48XX","NP48XY","NP48XZ","NP48YA","NP48YB","NP48YD","NP48YE","NP48YF","NP48YG","NP48YH","NP48YJ","NP48YL","NP48YN","NP48YP","NP48YQ","NP48YR","NP48YS","NP48YT","NP48YU","NP48YW","NP48YX","NP48YY","NP48YZ"]
      }
    };

    const prioritiesData = {
        blaenavon: {
            totalResponses: 254,
            priorities: [
                { name: "Youth Services & Activities", score: 120, description: "Providing more engaging activities and dedicated spaces for young people to socialise and learn new skills." },
                { name: "Transport", score: 104, description: "Improving local transport links and accessibility to make it easier for residents to travel for work, health, and leisure." },
                { name: "Antisocial Behaviour", score: 70, description: "Tackling issues of vandalism and disruptive behaviour to create a safer environment for everyone." },
                { name: "Health & Wellbeing", score: 61, description: "Supporting mental and physical health through community initiatives, workshops, and access to services." },
                { name: "Environment & Place (Maintenance)", score: 56, description: "Enhancing the local environment by maintaining public spaces, improving parks, and tackling litter." },
                { name: "Heritage & Tourism", score: 48, description: "Celebrating and promoting Blaenavon's rich history to boost local pride and attract visitors." }
            ]
        },
        thornhill: {
            totalResponses: 382,
            priorities: [
                { name: "Health & Wellbeing", score: 140, description: "Focusing on initiatives that support both the mental and physical health of the community residents." },
                { name: "Youth Services & Activities", score: 129, description: "Creating positive opportunities and safe spaces for young people to thrive." },
                { name: "Environmental Sustainability", score: 75, description: "Promoting green initiatives, recycling, and protecting local natural spaces for future generations." },
                { name: "Building Stronger Communities", score: 74, description: "Fostering a sense of belonging and connection through local events and collaborative projects." },
                { name: "Antisocial Behaviour", score: 28, description: "Addressing concerns about safety and nuisance to improve the quality of life for all residents." },
                { name: "Education & Skills", score: 23, description: "Providing learning opportunities for all ages, from digital literacy to practical life skills." }
            ]
        },
        trevethin: {
            totalResponses: 426,
            priorities: [
                { name: "Environment & Place (Maintenance)", score: 140, description: "Improving the appearance and usability of public spaces through better maintenance and community clean-ups." },
                { name: "Youth Services & Activities", score: 129, description: "Investing in facilities and programmes that offer constructive and engaging activities for young people." },
                { name: "Health & Wellbeing", score: 120, description: "Promoting healthy lifestyles and providing accessible support for the physical and mental wellbeing of residents." },
                { name: "Older People's Activities", score: 100, description: "Creating social opportunities and activities to combat isolation and support the older members of our community." },
                { name: "Crime & Community Safety", score: 75, description: "Working together to reduce crime and improve safety, making the area a more secure place to live." },
                { name: "Education & Skills", score: 74, description: "Offering programmes that help residents of all ages to learn new skills and improve their opportunities." }
            ]
        }
    };
    
    // ---------------
    // GLOBAL STATE & FIREBASE
    // ---------------
    let timelineScale = 1.0;
    let activeMilestoneIndex = 0;
    let prioritiesChart = null;
    let currentScoringState = {};
    let isDraggingPdfViewer = false;
    let pdfViewerOffsetX, pdfViewerOffsetY;

    let app;
    let auth;
    let db;
    let currentUserProfile = null;
    let scoresCollectionRef;
    let taskListenerUnsubscribe = null; 
    let adminDashboardUnsubscribe = null;
    let masterTrackerUnsubscribe = null;

    // ---------------
    // MODAL & GUIDE
    // ---------------
    function openGuideModal() {
        const modal = document.getElementById('guide-modal');
        if(modal) modal.classList.remove('hidden');
    }
    window.openGuideModal = openGuideModal;

    function closeGuideModal() {
        const modal = document.getElementById('guide-modal');
        if(modal) modal.classList.add('hidden');
    }
    window.closeGuideModal = closeGuideModal;

    // ---------------
    // PAGE NAVIGATION & AUTH
    // ---------------
     function showPage(pageId) {
        document.querySelectorAll('.page, .portal-page').forEach(p => p.style.display = 'none');
        
        const newPage = document.getElementById(pageId);
        if (newPage) newPage.style.display = 'block';
        
        if (pageId === 'page-timeline') {
            setTimeout(() => {
                updateTimelineNav();
                centerActiveMilestone();
            }, 100); 
        }
        if (pageId === 'page-priorities') {
            showPriorityArea('blaenavon');
        }
        window.scrollTo(0, 0);
    }
    window.showPage = showPage;
    
     function showPortalPage(pageId) {
        if (!currentUserProfile) {
            showPage('page-portal-login');
            return;
        }

        document.querySelectorAll('.page, .portal-page').forEach(p => p.style.display = 'none');
        const newPage = document.getElementById(pageId);
        if (newPage) newPage.style.display = 'block';

        const isAdmin = currentUserProfile.role === 'admin';
        document.getElementById('nav-portal-home').onclick = () => showPortalPage(isAdmin ? 'page-admin-dashboard' : 'page-portal-dashboard');
        document.querySelectorAll('.back-to-dashboard').forEach(btn => {
            btn.onclick = () => showPortalPage(isAdmin ? 'page-admin-dashboard' : 'page-portal-dashboard');
        });

        if (pageId === 'page-scoring') initializeScoringMatrix();
        if (pageId === 'page-portal-apps') initializeAppsViewer();
        if (pageId === 'page-portal-tracker') initializeMasterTracker();
        if (pageId === 'page-admin-dashboard') initializeAdminDashboard();
        
        window.scrollTo(0, 0);
    }
    window.showPortalPage = showPortalPage;

    async function login() {
        const usernameInput = document.getElementById('login-username');
        const passwordInput = document.getElementById('login-password');
        const messageDiv = document.getElementById('login-message');
        messageDiv.textContent = 'Signing in...';
        messageDiv.className = 'mt-4 text-center font-semibold text-gray-600 h-6';

        const username = usernameInput.value.trim();
        if (!username) {
            messageDiv.textContent = 'Please enter a username.';
            messageDiv.className = 'mt-4 text-center font-semibold text-red-600 h-6';
            return;
        }

        const email = `${username}@users.local`;

        try {
            await signInWithEmailAndPassword(auth, email, passwordInput.value);
            // onAuthStateChanged will handle the rest
            messageDiv.textContent = 'Success! Redirecting...';
            messageDiv.className = 'mt-4 text-center font-semibold text-green-600 h-6';
        } catch (error) {
            console.error("Login failed:", error.code, error.message);
            if (error.code === 'auth/invalid-credential' || error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found') {
                 messageDiv.textContent = 'Login failed. Please check your username and password.';
            } else {
                 messageDiv.textContent = 'An error occurred during login.';
            }
            messageDiv.className = 'mt-4 text-center font-semibold text-red-600 h-6';
        }
    }
    window.login = login;
    
    async function logout() {
        if (taskListenerUnsubscribe) taskListenerUnsubscribe();
        if (adminDashboardUnsubscribe) adminDashboardUnsubscribe();
        if (masterTrackerUnsubscribe) masterTrackerUnsubscribe();
        taskListenerUnsubscribe = null;
        adminDashboardUnsubscribe = null;
        masterTrackerUnsubscribe = null;
        
        await signOut(auth);
        currentUserProfile = null;
        document.getElementById('main-nav').style.display = 'flex';
        document.getElementById('portal-nav').style.display = 'none';
        showPage('page-landing');
    }
    window.logout = logout;

    async function handleAuthState(user) {
        if (user) {
            const userDocRef = doc(db, 'committeeMembers', user.uid);
            const userDocSnap = await getDoc(userDocRef);

            if (userDocSnap.exists()) {
                currentUserProfile = userDocSnap.data();
                
                document.getElementById('main-nav').style.display = 'none';
                document.getElementById('portal-nav').style.display = 'flex';
                document.getElementById('user-info').textContent = `Welcome, ${currentUserProfile.name}`;
                document.querySelectorAll('.admin-only').forEach(el => {
                    el.style.display = currentUserProfile.role === 'admin' ? 'block' : 'none';
                });
                showPortalPage(currentUserProfile.role === 'admin' ? 'page-admin-dashboard' : 'page-portal-dashboard');
            } else {
                console.error("No profile found for user:", user.uid);
                alert("Your account is authenticated, but no user profile was found. Please contact an administrator.");
                await logout();
            }
        } else {
            currentUserProfile = null;
            document.getElementById('main-nav').style.display = 'flex';
            document.getElementById('portal-nav').style.display = 'none';
            // If the user is on a portal page when they get logged out, redirect them.
            const currentPage = document.querySelector('.portal-page[style*="block"]');
            if (currentPage) {
                 showPage('page-landing');
            }
        }
    }

    function centerActiveMilestone() {
        const timelineContainer = document.getElementById('timeline-scroll-container');
        const activeMilestone = document.querySelector('.milestone.active');
        if (timelineContainer && activeMilestone) {
            const containerWidth = timelineContainer.offsetWidth;
            const milestoneLeft = activeMilestone.offsetLeft;
            const milestoneWidth = activeMilestone.offsetWidth;
            const desiredScrollLeft = milestoneLeft - (containerWidth / 2) + (milestoneWidth / 2);
            timelineContainer.scrollTo({ left: desiredScrollLeft, behavior: 'smooth' });
        }
    }

    function updateTimelineNav() {
        const timelineContainer = document.getElementById('timeline-scroll-container');
        const prevButton = document.getElementById('timeline-prev');
        const nextButton = document.getElementById('timeline-next');
        if (!timelineContainer || !prevButton || !nextButton) return;
        const maxScrollLeft = timelineContainer.scrollWidth - timelineContainer.clientWidth;
        prevButton.disabled = timelineContainer.scrollLeft <= 1; 
        nextButton.disabled = timelineContainer.scrollLeft >= maxScrollLeft - 1; 
    }

    function showVotingPage(areaName, formUrl) {
      const votingTitle = document.getElementById('voting-title');
      const votingText = document.getElementById('voting-text');
      const votingIframe = document.getElementById('voting-iframe');
      if(votingTitle && votingText && votingIframe) {
        votingTitle.innerText = `${areaName} PB Voting`;
        votingText.innerText = `Please complete the voting form for ${areaName} below. Choose your favourite three projects!`;
        votingIframe.src = formUrl;
        showPage('page-voting');
      }
    }

    function goToVotePage(areaKey) {
        showPage('page-postcode-check');
        const areaSelect = document.getElementById('area-select');
        if (areaSelect) {
            areaSelect.value = areaKey;
        }
    }
    window.goToVotePage = goToVotePage;
    
    // -----------------------
    // POSTCODE CHECKER
    // -----------------------
    function checkPostcode() {
      const areaSelect = document.getElementById('area-select');
      const postcode_input = document.getElementById('postcode-input');
      const messageDiv = document.getElementById('postcode-message');
      const selectedAreaKey = areaSelect.value;
      const rawPostcode = postcode_input.value;

      if (!selectedAreaKey) {
        messageDiv.textContent = 'Please select an area.';
        messageDiv.className = 'mt-4 text-center font-semibold text-red-600';
        return;
      }
      if (!rawPostcode) {
        messageDiv.textContent = 'Please enter your postcode.';
        messageDiv.className = 'mt-4 text-center font-semibold text-red-600';
        return;
      }

      const normalizedPostcode = rawPostcode.trim().toUpperCase().replace(/\s+/g, '');
      const selectedAreaData = areaData[selectedAreaKey];

      if (selectedAreaData && selectedAreaData.postcodes.includes(normalizedPostcode)) {
        messageDiv.textContent = 'Postcode verified! Redirecting...';
        messageDiv.className = 'mt-4 text-center font-semibold text-green-600';
        setTimeout(() => {
            showVotingPage(selectedAreaData.name, selectedAreaData.formUrl);
        }, 1500);
      } else {
        messageDiv.textContent = 'This postcode is not eligible for the selected area.';
        messageDiv.className = 'mt-4 text-center font-semibold text-red-600';
      }
    }
    window.checkPostcode = checkPostcode;

    // -----------------------
    // PRIORITIES PAGE
    // -----------------------
    function showPriorityArea(areaKey) {
        const contentDiv = document.getElementById('priorities-content');
        const data = prioritiesData[areaKey];
        if (!data) return;

        document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
        document.getElementById(`tab-${areaKey}`).classList.add('active');

        let priorityCardsHtml = data.priorities.map((p, index) => `
            <div class="priority-card rounded-xl shadow-lg p-6">
                <div class="flex items-center mb-3">
                    <span class="text-2xl font-bold text-purple-600 mr-4 dynapuff">#${index + 1}</span>
                    <h3 class="text-xl font-bold text-gray-800 dynapuff">${p.name}</h3>
                </div>
                <p class="text-gray-600 arial-nova">${p.description}</p>
            </div>
        `).join('');

        contentDiv.innerHTML = `
            <div class="grid md:grid-cols-12 gap-8">
                <div class="md:col-span-5 lg:col-span-4 bg-white p-6 rounded-xl shadow-xl">
                    <h2 class="text-2xl font-bold text-purple-700 mb-4 dynapuff">${areaData[areaKey].name}</h2>
                    <p class="text-gray-700 arial-nova mb-4">A total of <strong>${data.totalResponses} responses</strong> were gathered from this area, highlighting the key concerns and hopes of the community.</p>
                    <div class="h-64 lg:h-80"><canvas id="prioritiesChart"></canvas></div>
                </div>
                <div class="md:col-span-7 lg:col-span-8">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        ${priorityCardsHtml}
                    </div>
                </div>
            </div>
        `;
        renderPrioritiesChart(data);
    }
    window.showPriorityArea = showPriorityArea;

    function renderPrioritiesChart(data) {
        if (prioritiesChart) {
            prioritiesChart.destroy();
        }
        const ctx = document.getElementById('prioritiesChart').getContext('2d');
        prioritiesChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: data.priorities.map(p => p.name.replace(' & ', ' &\n')),
                datasets: [{
                    label: 'Number of Mentions',
                    data: data.priorities.map(p => p.score),
                    backgroundColor: ['rgba(147, 51, 234, 0.7)','rgba(167, 139, 250, 0.7)','rgba(20, 184, 166, 0.7)','rgba(99, 102, 241, 0.7)','rgba(234, 179, 8, 0.7)','rgba(236, 72, 153, 0.7)'],
                    borderColor: ['rgba(147, 51, 234, 1)','rgba(167, 139, 250, 1)','rgba(20, 184, 166, 1)','rgba(99, 102, 241, 1)','rgba(234, 179, 8, 1)','rgba(236, 72, 153, 1)'],
                    borderWidth: 1.5
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: { backgroundColor: '#374151', titleFont: { family: "'DynaPuff', cursive" }, bodyFont: { family: "'Arial Nova', Arial, sans-serif" }}
                },
                scales: {
                    y: { ticks: { font: { size: 11, family: "'Arial Nova', Arial, sans-serif" }}},
                    x: { beginAtZero: true }
                }
            }
        });
    }

    // -----------------------
    // TIMELINE IMPLEMENTATION
    // -----------------------
    const timelineEvents = [
      { title: "Jan - May 2025", label: "âHave Your Say!â", details: `<div class="p-4"><h3 class="text-lg font-bold text-purple-700 mb-2 dynapuff">January - May 2025: "Have Your Say!" Campaign</h3><ul class="list-disc ml-6 text-gray-700 arial-nova space-y-1"><li>The Communitiesâ Choice Fund runs its "Have Your Say!" campaign.</li><li>Aims to identify top five funding priorities for Blaenavon, Thornhill & Upper Cwmbran, and Trevethin, Penygarn & St. Cadocs.</li><li><b>1062 responses</b> received across areas.</li><li>Priorities established based on engagement and data.</li></ul></div>`},
      { title: "20 Jun 2025", label: "Applications Open", details: `<div class="p-4"><h3 class="text-lg font-bold text-purple-700 mb-2 dynapuff">Friday, 20th June 2025: Application Process Opens</h3><ul class="list-disc ml-6 text-gray-700 arial-nova"><li>Application process opens for Communitiesâ Choice Fund.</li><li>Applicants can submit Part 1 Expression of Interest (EOI) forms.</li></ul></div>`},
      { title: "1 Aug 2025", label: "EOI Deadline", details: `<div class="p-4"><h3 class="text-lg font-bold text-purple-700 mb-2 dynapuff">Friday, 1st August 2025 (Midnight): Deadline for Part 1 EOI Forms</h3><ul class="list-disc ml-6 text-gray-700 arial-nova"><li>Final deadline for submitting Part 1 EOI forms.</li><li>Late applications not considered for Part 2.</li></ul></div>`},
      { title: "Post 1 Aug", label: "EOI Assessment", details: `<div class="p-4"><h3 class="text-lg font-bold text-purple-700 mb-2 dynapuff">After 1st August 2025: EOI Assessment and Shortlisting</h3><ul class="list-disc ml-6 text-gray-700 arial-nova"><li>People Committees assess and score EOI forms.</li><li>Shortlisted applicants invited to complete Part 2.</li></ul></div>`},
      { title: "Pre 10 Sep", label: "Part 2 Completion", details: `<div class="p-4"><h3 class="text-lg font-bold text-purple-700 mb-2 dynapuff">Before Wednesday, 10th September 2025: Part 2 Application Completion</h3><ul class="list-disc ml-6 text-gray-700 arial-nova space-y-1"><li>Applicants complete detailed application form, delivery plan, and budget.</li><li>Attach supporting documents (constitution, policies, bank statements, certificates).</li><li>Cross-area applications need separate budget template.</li></ul></div>`},
      { title: "10 Sep 2025", label: "Full Application Deadline", details: `<div class="p-4"><h3 class="text-lg font-bold text-purple-700 mb-2 dynapuff">Wednesday, 10th September 2025: Deadline for Part 2 Full Application Forms</h3><ul class="list-disc ml-6 text-gray-700 arial-nova"><li>Deadline for submitting Part 2 forms to <a href="mailto:communities-choice@tvawales.org.uk" class="text-purple-600 underline">communities-choice@tvawales.org.uk</a>.</li><li>Late applications may not be considered unless pre-agreed.</li></ul></div>`},
      { title: "Post 10 Sep", label: "Final Assessment", details: `<div class="p-4"><h3 class="text-lg font-bold text-purple-700 mb-2 dynapuff">After 10th September 2025: Final Assessment by People's Committee</h3><ul class="list-disc ml-6 text-gray-700 arial-nova"><li>People Committees review Part 2 applications.</li><li>Decide which projects go to public vote.</li></ul></div>`},
      { title: "TBC", label: "Community Voting", details: `<div class="p-4"><h3 class="text-lg font-bold text-purple-700 mb-2 dynapuff">Undetermined Date(s): Community Voting Event(s)</h3><ul class="list-disc ml-6 text-gray-700 arial-nova space-y-1"><li>Finalists present projects at local events.</li><li>Residents vote for projects to be funded.</li><li>Top-voted projects reviewed and awarded funding.</li></ul></div>`}
    ];

    function renderTimelineBar() {
      const bar = document.querySelector('.timeline-bar');
      if (!bar) return;
      Array.from(bar.children).forEach(child => {
        if (!child.classList.contains('timeline-line') && child.id !== 'timeline-callout') {
            child.remove();
        }
      });
      const total = timelineEvents.length;
      timelineEvents.forEach((event, idx) => {
        const usableWidthPercent = 90; 
        const marginPercent = 5;
        const leftPercent = marginPercent + (idx / (total - 1)) * usableWidthPercent;
        const isAbove = idx % 2 === 0;
        const milestone = document.createElement('button');
        milestone.id = `milestone-${idx}`;
        milestone.className = `milestone ${isAbove ? 'above' : 'below'} ${activeMilestoneIndex === idx ? 'active' : (idx < activeMilestoneIndex ? 'completed' : 'upcoming')}`;
        milestone.style.left = `calc(${leftPercent}% - (18px * var(--timeline-scale)))`;
        milestone.setAttribute('aria-label', event.label);
        milestone.addEventListener('click', () => showMilestoneDetail(idx));
        bar.appendChild(milestone);

        const connector = document.createElement('div');
        connector.className = `connector ${isAbove ? 'above' : 'below'}`;
        connector.style.left = `calc(${leftPercent}% )`;
        bar.appendChild(connector);

        const label = document.createElement('div');
        label.className = `milestone-label ${isAbove ? 'above' : 'below'} dynapuff`;
        label.style.left = `calc(${leftPercent}% )`;
        label.innerText = event.label;
        bar.appendChild(label);

        const date = document.createElement('div');
        date.className = `milestone-date ${isAbove ? 'above' : 'below'} arial-nova`;
        date.style.left = `calc(${leftPercent}% )`;
        date.innerText = event.title;
        bar.appendChild(date);
      });
    }

    function showMilestoneDetail(idx) {
        activeMilestoneIndex = idx;
        renderTimelineBar();

        const milestoneElement = document.getElementById(`milestone-${idx}`);
        const callout = document.getElementById('timeline-callout');
        if (!milestoneElement || !callout) return;

        const isAbove = milestoneElement.classList.contains('above');
        callout.innerHTML = timelineEvents[idx].details;
        
        callout.classList.remove('show', 'from-above', 'from-below');

        requestAnimationFrame(() => {
            const milestoneLeft = milestoneElement.offsetLeft;
            const milestoneTop = milestoneElement.offsetTop;
            const milestoneWidth = milestoneElement.offsetWidth;
            const milestoneHeight = milestoneElement.offsetHeight;
            const calloutWidth = callout.offsetWidth;
            const calloutHeight = callout.offsetHeight;
            const pointerHeight = 10 * timelineScale;

            callout.className += isAbove ? ' from-above' : ' from-below';
            callout.style.display = 'block';

            let top, left;

            if (isAbove) {
                top = milestoneTop + milestoneHeight + pointerHeight;
            } else {
                top = milestoneTop - calloutHeight - pointerHeight;
            }
            left = milestoneLeft + (milestoneWidth / 2) - (calloutWidth / 2);

            const timelineContainer = document.getElementById('timeline-scroll-container');
            const visibleLeft = timelineContainer.scrollLeft;
            const visibleRight = visibleLeft + timelineContainer.clientWidth;

            if (left < visibleLeft) left = visibleLeft + 10;
            if (left + calloutWidth > visibleRight) left = visibleRight - calloutWidth - 10;
            
            callout.style.top = `${top}px`;
            callout.style.left = `${left}px`;
            callout.classList.add('show');
        });
    }

    function setTimelineScale(newScale) {
        timelineScale = Math.max(0.5, Math.min(1.8, newScale));
        document.documentElement.style.setProperty('--timeline-scale', timelineScale);
        document.getElementById('timeline-zoom-in').disabled = timelineScale >= 1.79;
        document.getElementById('timeline-zoom-out').disabled = timelineScale <= 0.51;

        setTimeout(() => {
            renderTimelineBar();
            showMilestoneDetail(activeMilestoneIndex);
            updateTimelineNav();
            centerActiveMilestone();
        }, 50);
    }
    
    function toggleTimelineFullscreen() {
      const container = document.getElementById('timeline-fullscreen-container');
      const enterIcon = document.getElementById('icon-fullscreen-enter');
      const exitIcon = document.getElementById('icon-fullscreen-exit');
      const isFullscreen = container.classList.toggle('fullscreen');
      document.documentElement.classList.toggle('timeline-fullscreen', isFullscreen);

      enterIcon.classList.toggle('hidden', isFullscreen);
      exitIcon.classList.toggle('hidden', !isFullscreen);
      
      setTimeout(() => {
        showMilestoneDetail(activeMilestoneIndex);
        centerActiveMilestone();
      }, 300);
    }

    // -----------------------
    // SCORING MATRIX
    // -----------------------
    const SCORING_DATA = {
        APPLICATIONS: [
            { ref: "PBBLN001", applicant: "Blaenavon Blues FC", area: "Blaenavon", pdfUrl: "https://cdn.jsdelivr.net/gh/danwtva-source/applications-test@main/PBBLN001.pdf" },
            { ref: "PBBLN002", applicant: "Blaenavon Camera Club", area: "Blaenavon", pdfUrl: "https://cdn.jsdelivr.net/gh/danwtva-source/applications-test@main/PBBLN002.pdf" },
            { ref: "PBBLN003", applicant: "Blaenavon Community Museum", area: "Blaenavon", pdfUrl: "https://cdn.jsdelivr.net/gh/danwtva-source/applications-test@main/PBBLN003.pdf" },
            { ref: "PBBLN004", applicant: "Blaenavon Male Voice Choir", area: "Blaenavon", pdfUrl: "https://cdn.jsdelivr.net/gh/danwtva-source/applications-test@main/PBBLN004.pdf" },
            { ref: "PBBLN005", applicant: "Blaenavon Mini and Juniors RFC", area: "Blaenavon", pdfUrl: "https://cdn.jsdelivr.net/gh/danwtva-source/applications-test@main/PBBLN005.pdf" },
            { ref: "PBBLN006", applicant: "Blaenavon Netball", area: "Blaenavon", pdfUrl: "https://cdn.jsdelivr.net/gh/danwtva-source/applications-test@main/PBBLN006.pdf" },
            { ref: "PBBLN007", applicant: "Blaenavon Town Band", area: "Blaenavon", pdfUrl: "https://cdn.jsdelivr.net/gh/danwtva-source/applications-test@main/PBBLN007.pdf" },
            { ref: "PBBLN008", applicant: "Blaenavon Youth Strategy", area: "Blaenavon", pdfUrl: "https://cdn.jsdelivr.net/gh/danwtva-source/applications-test@main/PBBLN008.pdf" },
            { ref: "PBBLN009", applicant: "Garnsychan Partnership", area: "Blaenavon", pdfUrl: "https://cdn.jsdelivr.net/gh/danwtva-source/applications-test@main/PBBLN009.pdf" },
            { ref: "PBBLN010", applicant: "Horticultural Group - Blaenavon Heritage School", area: "Blaenavon", pdfUrl: "https://cdn.jsdelivr.net/gh/danwtva-source/applications-test@main/PBBLN010.pdf" },
            { ref: "PBBLN011", applicant: "Little Oaks Retreat", area: "Blaenavon", pdfUrl: "https://cdn.jsdelivr.net/gh/danwtva-source/applications-test@main/PBBLN011.pdf" },
            { ref: "PBBLN012", applicant: "Torfaen Youth Service", area: "Blaenavon", pdfUrl: "https://cdn.jsdelivr.net/gh/danwtva-source/applications-test@main/PBBLN012.pdf" },
            { ref: "PBBLN013", applicant: "Welsh Language Conversation", area: "Blaenavon", pdfUrl: "https://cdn.jsdelivr.net/gh/danwtva-source/applications-test@main/PBBLN013.pdf" },
            { ref: "PBTUP001", applicant: "Able", area: "Thornhill & Upper Cwmbran", pdfUrl: "https://cdn.jsdelivr.net/gh/danwtva-source/applications-test@main/PBTUP001.pdf" },
            { ref: "PBTUP002", applicant: "Blaenbran Community Woodland", area: "Thornhill & Upper Cwmbran", pdfUrl: "https://cdn.jsdelivr.net/gh/danwtva-source/applications-test@main/PBTUP002.pdf" },
            { ref: "PBTUP003", applicant: "Garden of Hope - RecoverED", area: "Thornhill & Upper Cwmbran", pdfUrl: "https://cdn.jsdelivr.net/gh/danwtva-source/applications-test@main/PBTUP003.pdf" },
            { ref: "PBTUP004", applicant: "Graffiti Tutor", area: "Thornhill & Upper Cwmbran", pdfUrl: "https://cdn.jsdelivr.net/gh/danwtva-source/applications-test@main/PBTUP004.pdf" },
            { ref: "PBTUP005", applicant: "HIP HOP 12", area: "Thornhill & Upper Cwmbran", pdfUrl: "https://cdn.jsdelivr.net/gh/danwtva-source/applications-test@main/PBTUP005.pdf" },
            { ref: "PBTUP006", applicant: "Mindful Munch CafÃ© LLP", area: "Thornhill & Upper Cwmbran", pdfUrl: "https://cdn.jsdelivr.net/gh/danwtva-source/applications-test@main/PBTUP006.pdf" },
            { ref: "PBTUP007", applicant: "MOVE Against Cancer", area: "Thornhill & Upper Cwmbran", pdfUrl: "https://cdn.jsdelivr.net/gh/danwtva-source/applications-test@main/PBTUP007.pdf" },
            { ref: "PBTUP008", applicant: "Pontnewydd Male Voice Choir", area: "Thornhill & Upper Cwmbran", pdfUrl: "https://cdn.jsdelivr.net/gh/danwtva-source/applications-test@main/PBTUP008.pdf" },
            { ref: "PBTUP009", applicant: "Thornhill Community Centre - Messy Family Play (1)", area: "Thornhill & Upper Cwmbran", pdfUrl: "https://cdn.jsdelivr.net/gh/danwtva-source/applications-test@main/PBTUP009.pdf" },
            { ref: "PBTUP010", applicant: "Thornhill Community Centre - Play and Respite (2)", area: "Thornhill & Upper Cwmbran", pdfUrl: "https://cdn.jsdelivr.net/gh/danwtva-source/applications-test@main/PBTUP010.pdf" },
            { ref: "PBTPS001", applicant: "Age Connects", area: "Trevethin, Penygarn & St. Cadocs", pdfUrl: "https://cdn.jsdelivr.net/gh/danwtva-source/applications-test@main/PBTPS001.pdf" },
            { ref: "PBTPS002", applicant: "CBF - MUGA", area: "Trevethin, Penygarn & St. Cadocs", pdfUrl: "https://cdn.jsdelivr.net/gh/danwtva-source/applications-test@main/PBTPS002.pdf" },
            { ref: "PBTPS003", applicant: "Penygarn & Trevethin FC", area: "Trevethin, Penygarn & St. Cadocs", pdfUrl: "https://cdn.jsdelivr.net/gh/danwtva-source/applications-test@main/PBTPS003.pdf" },
            { ref: "PBTPS004", applicant: "Pleasant Court", area: "Trevethin, Penygarn & St. Cadocs", pdfUrl: "https://cdn.jsdelivr.net/gh/danwtva-source/applications-test@main/PBTPS004.pdf" },
            { ref: "PBTPS005", applicant: "Studio 77", area: "Trevethin, Penygarn & St. Cadocs", pdfUrl: "https://cdn.jsdelivr.net/gh/danwtva-source/applications-test@main/PBTPS005.pdf" },
            { ref: "PBTPS006", applicant: "TIDY BUTT", area: "Trevethin, Penygarn & St. Cadocs", pdfUrl: "https://cdn.jsdelivr.net/gh/danwtva-source/applications-test@main/PBTPS006.pdf" },
            { ref: "PBTPS007", applicant: "Torfaen Museum Trust", area: "Trevethin, Penygarn & St. Cadocs", pdfUrl: "https://cdn.jsdelivr.net/gh/danwtva-source/applications-test@main/PBTPS007.pdf" },
            { ref: "PBTPS008", applicant: "Torfaen Young Parents Group", area: "Trevethin, Penygarn & St. Cadocs", pdfUrl: "https://cdn.jsdelivr.net/gh/danwtva-source/applications-test@main/PBTPS008.pdf" },
            { ref: "PBTPS009", applicant: "Trevethin Community Centre", area: "Trevethin, Penygarn & St. Cadocs", pdfUrl: "https://cdn.jsdelivr.net/gh/danwtva-source/applications-test@main/PBTPS009.pdf" },
            { ref: "PBCRS001", applicant: "Abersychan Comprehensive School", area: "Cross-Area Application", pdfUrl: "https://cdn.jsdelivr.net/gh/danwtva-source/applications-test@main/PBCRS001.pdf" },
            { ref: "PBCRS002", applicant: "Giving Hope Torfaen", area: "Cross-Area Application", pdfUrl: "https://cdn.jsdelivr.net/gh/danwtva-source/applications-test@main/PBCRS002.pdf" },
            { ref: "PBCRS003", applicant: "Menterorar Taking Pride In Young People", area: "Cross-Area Application", pdfUrl: "https://cdn.jsdelivr.net/gh/danwtva-source/applications-test@main/PBCRS003.pdf" },
            { ref: "PBCRS004", applicant: "Torfaen Talks CIC", area: "Cross-Area Application", pdfUrl: "https://cdn.jsdelivr.net/gh/danwtva-source/applications-test@main/PBCRS004.pdf" },
            { ref: "PBCRS005", applicant: "Wrestle Cymru", area: "Cross-Area Application", pdfUrl: "https://cdn.jsdelivr.net/gh/danwtva-source/applications-test@main/PBCRS005.pdf" }
        ],
        CRITERIA_TEMPLATE: [
            { id: "priority", name: "Alignment with Local Priorities", guidance: "How well does the project align with the identified priorities for the area?", weight: 10, details: "<b>0:</b> No alignment with local priorities.<br><b>1:</b> Weak or unclear link to local priorities.<br><b>2:</b> Clear alignment with one or more local priorities.<br><b>3:</b> Strong, direct alignment with a top local priority." },
            { id: "impact", name: "Community Impact & Benefit", guidance: "How significant is the project's potential benefit to the community?", weight: 10, details: "<b>0:</b> No clear community benefit.<br><b>1:</b> Benefits a small, specific group of people.<br><b>2:</b> Benefits a significant portion of the community.<br><b>3:</b> Wide-reaching, significant, and lasting benefits for the community." },
            { id: "deliverability", name: "Deliverability & Value for Money", guidance: "How realistic is the project plan and budget? Does it represent good value?", weight: 10, details: "<b>0:</b> Unrealistic plan or budget; poor value for money.<br><b>1:</b> Some concerns about the plan's feasibility or budget justification.<br><b>2:</b> Realistic plan and budget that represents reasonable value.<br><b>3:</b> Excellent, well-thought-out plan and a well-justified budget offering exceptional value." },
            { id: "engagement", name: "Community Engagement & Collaboration", guidance: "How well does the project involve the community and collaborate with others?", weight: 10, details: "<b>0:</b> No evidence of community engagement or collaboration.<br><b>1:</b> Some consultation with the community or partners mentioned.<br><b>2:</b> Actively involves community members in the project's design or delivery.<br><b>3:</b> Strong partnerships and co-design with the community are central to the project." },
            { id: "sustainability", name: "Sustainability & Legacy", guidance: "Does the project have a plan for continuation or lasting impact?", weight: 10, details: "<b>0:</b> No legacy or plan for sustainability.<br><b>1:</b> The project is short-term with no clear lasting impact.<br><b>2:</b> The project has the potential for lasting impact or continuation.<br><b>3:</b> The project has a clear and realistic plan for continuation and lasting community benefit." },
            { id: "marmot", name: "Alignment with Marmot Principles", guidance: "How effectively does the project address health inequalities?", weight: 10, details: "<b>0:</b> No alignment.<br><b>1:</b> Weak link to principles.<br><b>2:</b> Clearly addresses one or more principles.<br><b>3:</b> Strong alignment with practical examples." },
            { id: "wfg", name: "Well-being of Future Generations (Wales) Act", guidance: "How does the project contribute to the well-being goals for Wales?", weight: 10, details: "<b>0:</b> No contribution.<br><b>1:</b> Weak link to goals.<br><b>2:</b> Clearly contributes to one or more goals.<br><b>3:</b> Strong alignment with practical examples." },
            { id: "innovation", name: "Innovation & Creativity", guidance: "Does the project offer a new or creative solution to a community issue?", weight: 10, details: "<b>0:</b> Conventional approach.<br><b>1:</b> Some new elements.<br><b>2:</b> Creative and innovative approach.<br><b>3:</b> Highly original and inspiring solution." },
            { id: "inclusivity", name: "Inclusivity & Equality", guidance: "How well does the project include and benefit diverse groups?", weight: 10, details: "<b>0:</b> Not inclusive.<br><b>1:</b> Limited reach to diverse groups.<br><b>2:</b> Accessible to most community groups.<br><b>3:</b> Proactively inclusive and removes barriers to participation." },
            { id: "evidence", name: "Evidence of Need", guidance: "Is there clear evidence that this project is needed in the community?", weight: 10, details: "<b>0:</b> No evidence of need provided.<br><b>1:</b> Anecdotal evidence of need.<br><b>2:</b> Supported by some local data or consultation.<br><b>3:</b> Strong evidence from community consultation and data." }
        ]
    };

    function initializeScoringMatrix() {
        if (!currentUserProfile) return;
        updateMemberAndView();
        
        document.getElementById('scoring-ref').addEventListener('change', (e) => handleAppSelection(e.target.value));
        document.getElementById('scoring-applicant').addEventListener('change', (e) => handleAppSelection(e.target.value));
        document.getElementById('scoring-threshold').addEventListener('input', updateTotalsAndOutcome);
        
        document.getElementById('scoring-post-final').addEventListener('click', postFinalScores);
        document.getElementById('scoring-export-csv').addEventListener('click', exportMasterTrackerToCSV);
        document.getElementById('scoring-clear').addEventListener('click', clearCurrentForm);
        document.getElementById('view-pdf-button').addEventListener('click', openPdfViewerForCurrentApp);
    }
    
    function updateMemberAndView() {
        if (!currentUserProfile) return;
        
        const filteredApps = getFilteredAppsForMember(currentUserProfile);
        populateApplicationDropdowns(filteredApps);

        const currentRef = document.getElementById('scoring-ref').value;
        if (currentRef && !filteredApps.some(app => app.ref === currentRef)) {
            handleAppSelection('');
        } else {
            handleAppSelection(currentRef || (filteredApps.length > 0 ? filteredApps[0].ref : ''));
        }

        if (taskListenerUnsubscribe) taskListenerUnsubscribe();
        const q = query(scoresCollectionRef, where("scorerId", "==", auth.currentUser.uid));
        taskListenerUnsubscribe = onSnapshot(q, (querySnapshot) => {
            const userScores = [];
            querySnapshot.forEach((doc) => {
                userScores.push({ ref: doc.data().ref, ...doc.data() });
            });
            renderTaskList(userScores);
        });
    }
    
    function getFilteredAppsForMember(memberProfile) {
        if (!memberProfile) return [];
        if (memberProfile.role === 'admin') return SCORING_DATA.APPLICATIONS;
        
        const memberArea = memberProfile.area;
        return SCORING_DATA.APPLICATIONS.filter(app => {
            return app.area === memberArea || app.area === 'Cross-Area Application';
        });
    }

    function populateApplicationDropdowns(apps) {
        const refSelect = document.getElementById('scoring-ref');
        const applicantSelect = document.getElementById('scoring-applicant');
        const currentRef = refSelect.value; 

        refSelect.innerHTML = '<option value="">Select Reference...</option>';
        apps.forEach(app => refSelect.add(new Option(app.ref, app.ref)));

        applicantSelect.innerHTML = '<option value="">Select Applicant...</option>';
        apps.forEach(app => applicantSelect.add(new Option(app.applicant.trim(), app.ref)));
        
        refSelect.value = currentRef; 
        applicantSelect.value = currentRef;
    }

    async function handleAppSelection(ref) {
        document.getElementById('scoring-ref').value = ref;
        document.getElementById('scoring-applicant').value = ref;

        const app = SCORING_DATA.APPLICATIONS.find(a => a.ref === ref);
        document.getElementById('scoring-area').value = app ? app.area : '';

        await loadScoresForRef(ref);
    }
    
     function initializeAppsViewer() {
        if (!currentUserProfile) return;
        populateAppsViewerList(currentUserProfile);
    }

    function populateAppsViewerList(memberProfile) {
        const listContainer = document.getElementById('app-viewer-list');
        const apps = getFilteredAppsForMember(memberProfile);
        listContainer.innerHTML = '';
        if (!apps || apps.length === 0) {
             listContainer.innerHTML = `<p class="text-gray-500 text-center p-4">No applications assigned.</p>`;
             return;
        }

        apps.forEach(app => {
            const button = document.createElement('button');
            button.className = 'w-full text-left p-3 rounded-md hover:bg-purple-100 transition-colors focus:outline-none focus:ring-2 focus:ring-purple-500';
            button.dataset.ref = app.ref;
            button.innerHTML = `
                <div class="font-bold text-gray-800">${app.applicant}</div>
                <div class="text-sm text-gray-500">${app.ref} - ${app.area}</div>
            `;
            button.addEventListener('click', () => viewApplication(app.ref));
            listContainer.appendChild(button);
        });
    }
    window.populateAppsViewerList = populateAppsViewerList;


    function viewApplication(ref) {
        const displayContainer = document.getElementById('app-viewer-display');
        const app = SCORING_DATA.APPLICATIONS.find(a => a.ref === ref);
        
         document.querySelectorAll('#app-viewer-list button').forEach(btn => {
            btn.classList.toggle('bg-purple-200', btn.dataset.ref === ref);
        });

        const pdfUrl = app.pdfUrl;
        displayContainer.innerHTML = `
             <div class="w-full p-2 bg-gray-100 rounded-t-lg border-b">
                <h3 class="font-bold text-gray-800">${app.applicant} (${app.ref})</h3>
             </div>
             <iframe src="${pdfUrl}" class="w-full h-full" title="PDF viewer for ${app.applicant}"></iframe>
        `;
    }
    window.viewApplication = viewApplication;

    function openPdfViewerForCurrentApp() {
        const ref = document.getElementById('scoring-ref').value;
        if (!ref) return;
        const app = SCORING_DATA.APPLICATIONS.find(a => a.ref === ref);
        
        const viewer = document.getElementById('pdf-viewer-window');
        const title = document.getElementById('pdf-viewer-title');
        const iframe = document.getElementById('pdf-viewer-iframe');

        title.textContent = `${app.applicant} (${app.ref})`;
        iframe.src = app.pdfUrl;
        
        if (!viewer.dataset.hasBeenMoved) {
            viewer.style.top = '50%';
            viewer.style.left = '50%';
            viewer.style.transform = 'translate(-50%, -50%)';
        }
        viewer.classList.remove('hidden');
    }
    window.openPdfViewerForCurrentApp = openPdfViewerForCurrentApp;

    function closePdfViewer() {
        const viewer = document.getElementById('pdf-viewer-window');
        const iframe = document.getElementById('pdf-viewer-iframe');
        iframe.src = 'about:blank'; 
        viewer.classList.add('hidden');
    }
    window.closePdfViewer = closePdfViewer;
    
    function makePdfViewerDraggable() {
        const viewer = document.getElementById('pdf-viewer-window');
        const header = document.getElementById('pdf-viewer-header');
        let isDragging = false, startX, startY, initialX, initialY;

        header.addEventListener('mousedown', function (e) {
            if (e.target.tagName === 'BUTTON' || e.target.closest('button')) return;
            e.preventDefault();
            isDragging = true;
            startX = e.clientX;
            startY = e.clientY;

            if (viewer.style.transform && viewer.style.transform !== 'none') {
                 const rect = viewer.getBoundingClientRect();
                 initialX = rect.left;
                 initialY = rect.top;
                 viewer.style.transform = 'none';
                 viewer.style.left = `${initialX}px`;
                 viewer.style.top = `${initialY}px`;
            } else {
                 initialX = viewer.offsetLeft;
                 initialY = viewer.offsetTop;
            }
            viewer.dataset.hasBeenMoved = 'true';
            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);
        });

        function onMouseMove(e) {
            if (isDragging) {
                const dx = e.clientX - startX;
                const dy = e.clientY - startY;
                const newX = Math.max(0, Math.min(initialX + dx, window.innerWidth - viewer.offsetWidth));
                const newY = Math.max(0, Math.min(initialY + dy, window.innerHeight - viewer.offsetHeight));
                viewer.style.left = `${newX}px`;
                viewer.style.top = `${newY}px`;
            }
        }

        function onMouseUp() {
            isDragging = false;
            document.removeEventListener('mousemove', onMouseMove);
            document.removeEventListener('mouseup', onMouseUp);
        }
    }

    // Task List Functions
    function loadTask(ref) {
        document.getElementById('scoring-ref').value = ref;
        document.getElementById('scoring-ref').dispatchEvent(new Event('change'));
    }
    window.loadTask = loadTask;

    function renderTaskList(userScores = []) {
        const container = document.getElementById('task-list-content');
        const summaryContainer = document.getElementById('task-list-summary');
        
        if (!currentUserProfile) {
            container.innerHTML = `<p class="text-gray-500 p-2">Loading...</p>`;
            summaryContainer.innerHTML = '';
            return;
        }

        const memberApps = getFilteredAppsForMember(currentUserProfile);
        if (memberApps.length === 0) {
            container.innerHTML = `<p class="text-gray-500 p-2">No applications assigned to your area.</p>`;
            summaryContainer.innerHTML = '';
            return;
        }

        let completedCount = 0;
        const tasksHtml = memberApps.map(app => {
            const scoreData = userScores.find(s => s.ref === app.ref);
            let statusBadge = '';
            if (scoreData && scoreData.isFinal) {
                completedCount++;
                statusBadge = '<span class="text-xs font-bold text-teal-600 bg-teal-100 px-2 py-1 rounded-full">Completed</span>';
            } else if (scoreData) {
                statusBadge = '<span class="text-xs font-bold text-yellow-600 bg-yellow-100 px-2 py-1 rounded-full">In Progress</span>';
            } else {
                statusBadge = '<span class="text-xs font-bold text-red-600 bg-red-100 px-2 py-1 rounded-full">Pending</span>';
            }
            return `<button onclick="loadTask('${app.ref}')" class="w-full text-left p-2 rounded-md task-list-button"><div class="flex justify-between items-center"><span class="text-sm">${app.ref} - ${app.applicant}</span>${statusBadge}</div></button>`;
        }).join('');
        
        container.innerHTML = tasksHtml;
        
        const progress = (completedCount / memberApps.length) * 100;
        if (progress === 100 && memberApps.length > 0) {
            summaryContainer.innerHTML = `<div class="text-center p-4 bg-teal-100 text-teal-800 rounded-lg mt-4 font-bold">ð All applications scored!</div>`;
        } else {
            summaryContainer.innerHTML = `<p class="text-sm font-semibold text-gray-700">${completedCount} of ${memberApps.length} scored.</p><div class="w-full bg-gray-200 rounded-full h-2.5 mt-1"><div class="bg-teal-600 h-2.5 rounded-full" style="width: ${progress}%"></div></div>`;
        }
    }
    
    // Admin Master Tracker
    async function deleteScore(docId) {
        if (confirm(`Are you sure you want to PERMANENTLY delete this score? This action cannot be undone.`)) {
            try {
                const docRef = doc(scoresCollectionRef, docId);
                await deleteDoc(docRef);
                console.log("Score deleted successfully");
            } catch (error) {
                console.error("Error deleting score: ", error);
                alert("Failed to delete score. See console for details.");
            }
        }
    }
    window.deleteScore = deleteScore;

    function initializeMasterTracker() {
        if (masterTrackerUnsubscribe) masterTrackerUnsubscribe();
        masterTrackerUnsubscribe = onSnapshot(scoresCollectionRef, (snapshot) => {
            const allScores = [];
            snapshot.forEach(doc => allScores.push({ id: doc.id, ...doc.data() }));
            renderMasterTrackerView(allScores);
        });
    }

    function renderMasterTrackerView(allScores) {
        const container = document.getElementById('master-tracker-view');
        if (!currentUserProfile || currentUserProfile.role !== 'admin') {
            container.innerHTML = `<div class="text-center p-8 bg-red-50 border-2 border-red-200 rounded-lg"><h2 class="text-2xl font-bold text-red-700 dynapuff">Access Denied</h2><p class="text-red-600 mt-2">You must be an administrator to view the master tracker.</p></div>`;
            return;
        }

        if (allScores.length === 0) {
            container.innerHTML = `<p class="text-center text-gray-500">The Master Tracker is currently empty.</p>`;
            return;
        }
        
         const scoresByApp = allScores.reduce((acc, score) => {
            if (!acc[score.ref]) {
                const appDetails = SCORING_DATA.APPLICATIONS.find(a => a.ref === score.ref);
                acc[score.ref] = { ...appDetails, scores: [] };
            }
            acc[score.ref].scores.push({ ...score });
            return acc;
        }, {});

        const appHtml = Object.values(scoresByApp).map(app => {
            const scoresHtml = app.scores.map(s => `
                <div class="flex justify-between items-center text-sm p-2 bg-gray-50 rounded">
                    <div>
                        <span class="font-semibold text-gray-700">${s.scorerName}</span>
                        <span class="font-bold text-purple-700 ml-4">${s.totalScore} / 100</span>
                    </div>
                    <button onclick="deleteScore('${s.id}')" class="text-red-500 hover:text-red-700 p-1 rounded-full transition-colors" title="Delete this score"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>
                </div>
            `).join('');

            return `<div class="border border-gray-200 rounded-lg overflow-hidden"><div class="bg-gray-100 p-3"><h4 class="font-bold text-lg text-purple-800 dynapuff">${app.applicant}</h4><p class="text-sm text-gray-600">${app.ref} - ${app.area}</p></div><div class="p-3 space-y-2">${scoresHtml}</div></div>`;
        }).join('');
        
        container.innerHTML = `<div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">${appHtml}</div>`;
    }

    function initializeAdminDashboard() {
        const filterSelect = document.getElementById('admin-area-filter');
        const render = (allScores) => {
            if (!db) return; // Guard against premature rendering
            const committeeMembersCollectionRef = collection(db, 'committeeMembers');
            const q = query(committeeMembersCollectionRef, where("role", "==", "member"));
            
            onSnapshot(q, (snapshot) => {
                let committeeMembers = [];
                snapshot.forEach(doc => committeeMembers.push(doc.data()));
                
                if (filterSelect.value !== 'All') {
                    committeeMembers = committeeMembers.filter(m => m.area === filterSelect.value);
                }
                renderAdminDashboard(committeeMembers, allScores);
            });
        };

        if (adminDashboardUnsubscribe) adminDashboardUnsubscribe();
        adminDashboardUnsubscribe = onSnapshot(scoresCollectionRef, (snapshot) => {
            const allScores = [];
            snapshot.forEach(doc => allScores.push(doc.data()));
            render(allScores);
        });

        filterSelect.addEventListener('change', () => {
             if (adminDashboardUnsubscribe) adminDashboardUnsubscribe();
             adminDashboardUnsubscribe = onSnapshot(scoresCollectionRef, (snapshot) => {
                const allScores = [];
                snapshot.forEach(doc => allScores.push(doc.data()));
                render(allScores);
             });
        });
    }

    function renderAdminDashboard(committeeMembers, allScores) {
        const container = document.getElementById('admin-dashboard-content');
        if (!container) return;
        
        const memberCardsHtml = committeeMembers.map(member => {
            const assignedApps = getFilteredAppsForMember(member);
            let completedCount = 0;
            const applistHtml = assignedApps.map(app => {
                const score = allScores.find(s => s.scorerName === member.name && s.ref === app.ref);
                let isComplete = false;
                if (score && score.isFinal) {
                    completedCount++;
                    isComplete = true;
                }
                return `<li class="flex justify-between items-center text-sm py-1"><span>${app.ref}</span>${isComplete ? '<span class="text-xs font-semibold text-teal-700">Completed</span>' : '<span class="text-xs font-semibold text-red-700">Outstanding</span>'}</li>`;
            }).join('');
            const totalCount = assignedApps.length;
            const progress = totalCount > 0 ? (completedCount / totalCount) * 100 : 0;
            return `<div class="bg-white p-6 rounded-xl shadow-lg"><h3 class="text-xl font-bold text-purple-800 dynapuff">${member.name}</h3><p class="text-sm text-gray-600 mb-3">${member.area}</p><div class="mb-2"><p class="text-sm font-semibold text-gray-700">${completedCount} of ${totalCount} scored.</p><div class="w-full bg-gray-200 rounded-full h-2.5 mt-1"><div class="bg-teal-600 h-2.5 rounded-full" style="width: ${progress}%"></div></div></div><details><summary class="text-sm font-semibold text-purple-600 cursor-pointer hover:underline">View Assigned</summary><ul class="mt-2 space-y-1 divide-y divide-gray-200">${applistHtml}</ul></details></div>`;
        }).join('');
        container.innerHTML = `<div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">${memberCardsHtml}</div>`;
    }

    function deepClone(obj) { return JSON.parse(JSON.stringify(obj)); }

    async function loadScoresForRef(ref) {
        const finalizedMessage = document.getElementById('scoring-finalized-message');
        const saveButton = document.getElementById('scoring-post-final'); 
        
        finalizedMessage.classList.add('hidden');
        document.getElementById('view-pdf-button').disabled = !ref;

        if (!ref || !currentUserProfile) {
            currentScoringState = {};
            renderScoringMatrix([]);
            updateTotalsAndOutcome();
            return;
        }
        
        const docId = `${auth.currentUser.uid}_${ref}`;
        const docRef = doc(scoresCollectionRef, docId);
        const docSnap = await getDoc(docRef);
        const savedData = docSnap.exists() ? docSnap.data() : {};

        const criteria = deepClone(SCORING_DATA.CRITERIA_TEMPLATE).map(c => {
            const savedCriterion = savedData.criteria ? savedData.criteria.find(sc => sc.id === c.id) : null;
            return { ...c, score: savedCriterion?.score ?? 0, notes: savedCriterion?.notes ?? '' };
        });
        
        currentScoringState = { ref, criteria, isFinal: savedData.isFinal || false };
        renderScoringMatrix(criteria);
        updateTotalsAndOutcome();

        const isFinal = savedData.isFinal || false;
        document.querySelectorAll('#scoring-matrix-body input, #scoring-matrix-body textarea, #scoring-clear').forEach(el => el.disabled = isFinal);
        saveButton.disabled = isFinal;

        if(isFinal) {
            finalizedMessage.textContent = "These scores have been posted and are now read-only.";
            finalizedMessage.classList.remove('hidden');
        }
    }
    
    function renderScoringMatrix(criteria) {
        const tbody = document.getElementById('scoring-matrix-body');
        tbody.innerHTML = ''; 

        if (!currentUserProfile) {
             tbody.innerHTML = `<tr><td colspan="4" class="text-center text-gray-500 py-8">Authenticating...</td></tr>`;
             return;
        }
        if (criteria.length === 0) {
            tbody.innerHTML = `<tr><td colspan="4" class="text-center text-gray-500 py-8">Please select an application to begin scoring.</td></tr>`;
            return;
        }

        criteria.forEach(c => {
            const row = document.createElement('tr');
            row.innerHTML = `<td class="font-bold text-gray-800"><div class="flex items-center"><span>${c.name}</span><div class="tooltip-container"><svg class="tooltip-icon w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg><div class="tooltip-text">${c.details}</div></div></div></td><td class="text-sm text-gray-600">${c.guidance}</td><td><div class="flex items-center space-x-2"><input type="range" min="0" max="3" value="${c.score || 0}" class="score-slider w-full" data-id="${c.id}"><span class="font-bold text-purple-700 text-lg w-4 text-center">${c.score || 0}</span></div></td><td><textarea class="w-full p-2 border border-gray-300 rounded-md" rows="2" placeholder="Enter justification..." data-id="${c.id}">${c.notes || ''}</textarea></td>`;
            tbody.appendChild(row);
        });

        tbody.querySelectorAll('input[type="range"]').forEach(input => {
            input.addEventListener('input', (e) => {
                const id = e.target.dataset.id;
                const score = parseInt(e.target.value, 10);
                e.target.nextElementSibling.textContent = score;
                updateScore(id, score);
            });
        });
        tbody.querySelectorAll('textarea').forEach(textarea => {
            textarea.addEventListener('input', (e) => {
                const id = e.target.dataset.id;
                const notes = e.target.value;
                updateNotes(id, notes);
            });
        });
    }

    function updateScore(criterionId, score) {
        if (!currentScoringState.criteria) return;
        const criterion = currentScoringState.criteria.find(c => c.id === criterionId);
        if (criterion) {
            criterion.score = score;
            saveProgress();
            updateTotalsAndOutcome();
        }
    }
    
    function updateNotes(criterionId, notes) {
         if (!currentScoringState.criteria) return;
        const criterion = currentScoringState.criteria.find(c => c.id === criterionId);
        if (criterion) {
            criterion.notes = notes;
            saveProgress();
        }
    }

    function updateTotalsAndOutcome() {
        const totalEl = document.getElementById('scoring-total');
        const outcomeEl = document.getElementById('scoring-outcome');
        const threshold = parseInt(document.getElementById('scoring-threshold').value, 10) || 65;

        if (!currentScoringState.criteria || currentScoringState.criteria.length === 0) {
            totalEl.textContent = '0 / 100';
            outcomeEl.textContent = 'N/A';
            outcomeEl.className = 'px-4 py-1 text-lg font-bold text-white rounded-full bg-gray-400';
            return;
        }

        const totalScore = currentScoringState.criteria.reduce((acc, c) => acc + ((c.score || 0) / 3) * c.weight, 0);
        const finalScore = Math.round(totalScore);
        totalEl.textContent = `${finalScore} / 100`;

        if (finalScore >= threshold) {
            outcomeEl.textContent = 'Green';
            outcomeEl.className = 'px-4 py-1 text-lg font-bold text-white rounded-full bg-teal-500';
        } else if (finalScore >= threshold * 0.7) {
            outcomeEl.textContent = 'Amber';
            outcomeEl.className = 'px-4 py-1 text-lg font-bold text-white rounded-full bg-yellow-500';
        } else {
            outcomeEl.textContent = 'Red';
            outcomeEl.className = 'px-4 py-1 text-lg font-bold text-white rounded-full bg-red-500';
        }
    }
    
    async function saveProgress() {
        if (currentScoringState.ref && currentUserProfile && !currentScoringState.isFinal) {
            const docId = `${auth.currentUser.uid}_${currentScoringState.ref}`;
            const docRef = doc(scoresCollectionRef, docId);
            const dataToSave = {
                ...currentScoringState,
                scorerId: auth.currentUser.uid,
                scorerName: currentUserProfile.name,
                isFinal: false
            };
            try {
                await setDoc(docRef, dataToSave, { merge: true });
            } catch (error) {
                console.error("Error saving progress:", error);
            }
        }
    }

    async function postFinalScores() {
        if (!currentScoringState.ref || !currentUserProfile) {
            alert('Please select an application first.');
            return;
        }

        if (confirm(`Are you sure you want to post these scores as FINAL for ${currentScoringState.ref}? You will not be able to edit them after posting.`)) {
            const docId = `${auth.currentUser.uid}_${currentScoringState.ref}`;
            const docRef = doc(scoresCollectionRef, docId);
            const totalScore = Math.round(currentScoringState.criteria.reduce((acc, c) => acc + ((c.score || 0) / 3) * c.weight, 0));
            const finalScores = {
                ...currentScoringState,
                scorerId: auth.currentUser.uid,
                scorerName: currentUserProfile.name,
                totalScore,
                isFinal: true,
                timestamp: new Date().toISOString()
            };

            try {
                await setDoc(docRef, finalScores);
                const statusEl = document.getElementById('scoring-status');
                statusEl.textContent = `Final scores posted for ${currentScoringState.ref}!`;
                setTimeout(() => statusEl.textContent = '', 3000);
                loadScoresForRef(currentScoringState.ref);
            } catch (error) {
                console.error("Error posting final scores: ", error);
                alert("Failed to post scores. See console for details.");
            }
        }
    }

    async function clearCurrentForm() {
        const ref = document.getElementById('scoring-ref').value;
        if (!ref || !currentUserProfile) {
            alert("Please select an application first.");
            return;
        }
        if(confirm(`Are you sure you want to clear all scores and notes for ${ref}? This will be permanently deleted.`)) {
            const docId = `${auth.currentUser.uid}_${ref}`;
            const docRef = doc(scoresCollectionRef, docId);
            try {
                await deleteDoc(docRef);
                handleAppSelection(ref); // Reload to show cleared form
            } catch (error) {
                console.error("Error clearing form: ", error);
                alert("Failed to clear form. See console for details.");
            }
        }
    }
    
    function exportMasterTrackerToCSV() {
        alert("Export functionality to be implemented using Firestore data.");
    }

    // ----------------
    // INITIALIZATION
    // ----------------
    document.addEventListener('DOMContentLoaded', async () => {
      const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
      const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

      if (!firebaseConfig) {
          console.error("Firebase config not found!");
          document.body.innerHTML = "<h1>Error: Firebase configuration is missing.</h1>";
          return;
      }

      app = initializeApp(firebaseConfig);
      auth = getAuth(app);
      db = getFirestore(app);
      setLogLevel('debug');
      
      // Note: The collection path for scores is now at the root as per user's latest setup.
      // This is less secure and might require adjusting security rules.
      scoresCollectionRef = collection(db, 'scores'); 

      onAuthStateChanged(auth, handleAuthState);
      
      // --- UI Initial Setup ---
      showPage('page-landing');

      const demoDate = new Date();
      const eventDates = [new Date('2025-05-31'), new Date('2025-06-20'), new Date('2025-08-01'), new Date('2025-08-15'), new Date('2025-09-09'), new Date('2025-09-10'), new Date('2025-09-20'), new Date('2025-10-01')];
      activeMilestoneIndex = eventDates.findIndex(d => demoDate <= d);
      if(activeMilestoneIndex === -1) activeMilestoneIndex = eventDates.length - 1;

      new Swiper('.swiper', {
        loop: true,
        pagination: { el: '.swiper-pagination', clickable: true },
        navigation: { nextEl: '.swiper-button-next', prevEl: '.swiper-button-prev' },
      });

      // --- Timeline Setup ---
      renderTimelineBar();
      setTimeout(() => showMilestoneDetail(activeMilestoneIndex), 100);
      makePdfViewerDraggable();

      const timelineContainer = document.getElementById('timeline-scroll-container');
      const prevButton = document.getElementById('timeline-prev');
      const nextButton = document.getElementById('timeline-next');
      
      if(timelineContainer) timelineContainer.addEventListener('scroll', updateTimelineNav);
      if(prevButton) prevButton.addEventListener('click', () => timelineContainer.scrollBy({ left: -timelineContainer.clientWidth * 0.75, behavior: 'smooth' }));
      if(nextButton) nextButton.addEventListener('click', () => timelineContainer.scrollBy({ left: timelineContainer.clientWidth * 0.75, behavior: 'smooth' }));
      document.getElementById('timeline-zoom-in')?.addEventListener('click', () => setTimelineScale(timelineScale + 0.2));
      document.getElementById('timeline-zoom-out')?.addEventListener('click', () => setTimelineScale(timelineScale - 0.2));
      document.getElementById('timeline-fullscreen-toggle')?.addEventListener('click', toggleTimelineFullscreen);
    });
  </script>
</body>
</html>